<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚ã¤æ£®ï½œã‚«ãƒ–ä¾¡è¨ˆç®—ãƒ»åˆ©ç›Šè¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #fdfae6;
            color: #4a3c31;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        body.no-ruby rt { display: none; }

        .container {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 450px;
        }
        h2 { text-align: center; color: #789440; margin-bottom: 20px; }

        #rubyToggle{
            display:block;
            margin: 0 auto 15px;
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid #789440;
            background: #fff;
            cursor: pointer;
            font-size: 0.85em;
        }

        .box {
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 15px;
            border-left: 12px solid;
        }
        .input-group { margin-bottom: 15px; }
        label {
            display: block;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        ruby { font-style: normal; }
        rt { font-size: 0.6em; font-weight: normal; }

        input[type="text"] {
            width: 80%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 18px;
            outline: none;
            background: #fff;
            color: #4a3c31;
            text-align: right;
            padding-right: 15px;
        }
        input[type="text"]:focus { border-color: #789440; }

        input[type="text"]:disabled {
            background: #eceff1;
            color: transparent;
            border-color: #cfd8dc;
            cursor: not-allowed;
        }
        input[type="text"]:disabled::placeholder { color: transparent; }
        ::placeholder { color: #ccc; opacity: 1; }

        .buy { border-color: #ffd54f; background-color: #fffde7; }
        .sell { border-color: #81c784; background-color: #f1f8e9; }
        .goal { border-color: #ff8a65; background-color: #fff3e0; }
        .plan { border-color: #4db6ac; background-color: #e0f2f1; }
        .atm { border-color: #d1c4e9; background-color: #f3e5f5; }
        .memo { border-color: #90a4ae; background-color: #eceff1; }

        .result-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            font-weight: bold;
            line-height: 1.8;
        }

        .red-val { color: #d32f2f; font-size: 1.3em; }
        .blue-val { color: #03a9f4; }
        .sub-text { font-size: 0.85em; color: #795548; margin-bottom: 5px; }
        .separator { font-size: 1.2em; font-weight: bold; margin: 0 10px; color: #795548; }

        .trip-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .highlight-box {
            background: #fff9c4;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 2px dashed #ffb300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
        }
        .highlight-box.small { background: #f0f4c3; border-color: #afb42b; }

        .highlight-box.plan-style {
            background: #b2dfdb;
            border-color: #00897b;
            grid-column: span 2;
            text-align: left;
            padding: 12px 15px;
            width: 90%;
            display: block;
            line-height: 1.65;
        }

        .plan-style div { margin: 0; }
        .plan-style ul { margin: 8px 0 0; }
        .plan-style ul:last-child { margin-bottom: 0; }
        .plan-style > :last-child { margin-bottom: 0 !important; }

        #planOutput { white-space: normal; word-break: keep-all; }

        #planOutput.plan-empty {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 70px;
        }
        #planOutput .empty-msg{ white-space: nowrap; }

        .trip-num { font-size: 1.4em; color: #e64a19; display: block; }
        .capacity-label { font-size: 0.75em; color: #558b2f; margin-top: 2px; }

        .step-list {
            margin: 10px 0 0;
            padding-left: 20px;
            font-size: 0.9em;
            color: #00695c;
            line-height: 1.6;
        }
        .step-list li{ margin: 0; padding: 0; }

        .step-note{
            margin: 0 0 0 20px;
            font-size: 0.9em;
            color: #00695c;
            line-height: 1.6;
            font-weight: bold;
            display: block;
            width: 100%;
            text-align: left !important;
        }

        #tripAlert {
            background: #ffecb3;
            border-color: #ffa000;
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            border: 2px dashed #ffa000;
            margin-top: 10px;
            line-height: 1.6;
        }

        /* ãƒ¡ãƒ¢UI */
        .memo-row{
            display:flex;
            gap:10px;
            align-items:center;
            flex-wrap:wrap;
        }
        .memo-mini{
            font-size: 0.9em;
            color: #455a64;
            line-height: 1.5;
        }
        .btn{
            border: 1px solid #90a4ae;
            background:#fff;
            border-radius: 10px;
            padding: 8px 10px;
            cursor:pointer;
            font-size: 0.9em;
        }
        .btn.small{
            padding: 6px 10px;
            border-radius: 999px;
        }
        .btn.primary{
            border-color:#607d8b;
        }
        .btn.danger{
            border-color:#c62828;
            color:#c62828;
        }
        textarea{
            width: 95%;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            background:#fff;
            color:#4a3c31;
            outline:none;
        }
        textarea:focus{ border-color:#90a4ae; }

        .counter{
            display:flex;
            align-items:center;
            gap:10px;
        }
        .counter .val{
            min-width: 64px;
            text-align:center;
            font-size: 1.2em;
            color:#37474f;
            font-weight:bold;
            background:#fff;
            border: 2px dashed #90a4ae;
            border-radius: 12px;
            padding: 6px 10px;
        }
        .auto-box{
            margin-top: 8px;
            padding: 10px 12px;
            border-radius: 12px;
            background:#fff;
            border: 2px dashed #b0bec5;
            color:#37474f;
            line-height: 1.6;
        }
        .mono{
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ã‚«ãƒ–ä¾¡è¨ˆç®—ãƒ»åˆ©ç›Šè¨ˆç®—ãƒ„ãƒ¼ãƒ«</h2>

    <button id="rubyToggle" type="button">ãµã‚ŠãŒãªï¼šON</button>

    <div class="box buy">
        <label>
            <ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>
            <span style="font-size: 0.7em; font-weight: normal;">ï¼ˆã‚«ãƒ–ã‚’<ruby>è²·<rt>ã‹</rt></ruby>ã†<ruby>å€¤æ®µ<rt>ã­ã ã‚“</rt></ruby>ï¼‰</span>
        </label>

        <div class="input-group">
            <p class="sub-text">1ã‚«ãƒ–ã®<ruby>å€¤æ®µ<rt>ã­ã ã‚“</rt></ruby></p>
            <input type="text" id="buyPrice" placeholder="90" class="comma-input">
        </div>
        <div class="input-group">
            <p class="sub-text">æŒã¦ã‚‹<ruby>é‡<rt>ã‚Šã‚‡ã†</rt></ruby>ï¼ˆ1<ruby>åˆ—<rt>ã‚Œã¤</rt></ruby>ï¼10ãƒã‚¹ / <ruby>æœ€å¤§<rt>ã•ã„ã ã„</rt></ruby>4<ruby>åˆ—<rt>ã‚Œã¤</rt></ruby>ï¼‰</p>
            <div style="display: flex; align-items: center;">
                <input type="text" id="rows" placeholder="2" class="comma-input"> <span style="font-size:0.8em; margin-left:5px;">åˆ—</span>
                <span class="separator">ï¼‹</span>
                <input type="text" id="slots" placeholder="5" class="comma-input"> <span style="font-size:0.8em; margin-left:5px;">ãƒã‚¹</span>
            </div>
            <div id="maxAlert" style="color: #d32f2f; font-size: 0.7em; margin-top: 5px; display: none; font-weight: bold;">
                â€»4åˆ—ï¼ˆ40ãƒã‚¹ï¼‰ãŒæœ€å¤§ã§ã™
            </div>
        </div>
        <div class="result-card">
            <ruby>åˆè¨ˆ<rt>ã”ã†ã‘ã„</rt></ruby>ï¼š<span id="totalStocks">0</span> ã‚«ãƒ–<br>
            <ruby>æ”¯æ‰•é¡<rt>ã—ã¯ã‚‰ã„ãŒã</rt></ruby>ï¼š<span id="cost" class="red-val">0</span> ãƒ™ãƒ«
        </div>
    </div>

    <div class="box sell">
        <label><ruby>å£²å€¤<rt>ã†ã‚Šã­</rt></ruby>
        <span style="font-size: 0.7em; font-weight: normal;">ï¼ˆã‚«ãƒ–ã‚’<ruby>å£²<rt>ã†</rt></ruby>ã‚‹<ruby>å€¤æ®µ<rt>ã­ã ã‚“</rt></ruby>ï¼‰</span></label>
        <div class="input-group">
            <p class="sub-text">1ã‚«ãƒ–ã®<ruby>å€¤æ®µ<rt>ã­ã ã‚“</rt></ruby></p>
            <input type="text" id="sellPrice" placeholder="660" class="comma-input">
        </div>
        <div class="result-card">
            <span class="sub-text">â€»<span id="targetStocks">0</span> ã‚«ãƒ–<ruby>å£²å´æ™‚<rt>ã°ã„ãã‚ƒãã˜</rt></ruby></span><br>
            <ruby>å—å–é¡<rt>ã†ã‘ã¨ã‚ŠãŒã</rt></ruby>ï¼š<span id="sales" class="red-val">0</span> ãƒ™ãƒ«<br>
            <span class="blue-val"><ruby>åˆ©ç›Š<rt>ã‚Šãˆã</rt></ruby>ï¼šï¼‹ <span id="profit">0</span> ãƒ™ãƒ«</span>
        </div>
    </div>

    <div class="box goal">
        <label>ã€<ruby>ç›®æ¨™é”æˆ<rt>ã‚‚ãã²ã‚‡ã†ãŸã£ã›ã„</rt></ruby>ã¸ã®<ruby>é“<rt>ã¿ã¡</rt></ruby>ã€‘</label>
        <div class="input-group">
            <p class="sub-text"><ruby>ç¾åœ¨<rt>ã’ã‚“ã–ã„</rt></ruby>ã®<ruby>è²¯é‡‘é¡<rt>ã¡ã‚‡ãã‚“ãŒã</rt></ruby></p>
            <input type="text" id="currentBank" placeholder="0" class="comma-input">
        </div>
        <div class="input-group">
            <p class="sub-text"><ruby>ç›®æ¨™<rt>ã‚‚ãã²ã‚‡ã†</rt></ruby>ã®<ruby>é‡‘é¡<rt>ãã‚“ãŒã</rt></ruby></p>
            <input type="text" id="targetBank" placeholder="999,999,999" class="comma-input">
        </div>
        <div class="result-card">
            <ruby>ä¸è¶³é¡<rt>ãµãããŒã</rt></ruby>ï¼š<span id="neededAmount" class="red-val">0</span> ãƒ™ãƒ«
            <div id="tripDisplay" class="trip-compare">
                <div class="highlight-box">
                    <span class="sub-text">ã‚«ãƒãƒ³<ruby>æœ€å¤§<rt>ã•ã„ã ã„</rt></ruby></span>
                    <span class="capacity-label">(40ãƒã‚¹)</span>
                    <span class="trip-num"><span id="tripsFull">0</span><ruby>å›<rt>ã‹ã„</rt></ruby></span>
                </div>
                <div class="highlight-box small">
                    <span class="sub-text"><ruby>ä»Š<rt>ã„ã¾</rt></ruby>ã®<ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby></span>
                    <span class="capacity-label">(ã‚«ãƒãƒ³<span id="currentCapacityText">0</span>ãƒã‚¹)</span>
                    <span class="trip-num"><span id="tripsCurrent">0</span><ruby>å›<rt>ã‹ã„</rt></ruby></span>
                </div>
            </div>
            <div id="tripAlert" style="display:none;">
                <span class="red-val" style="font-weight:bold;"><ruby>è³‡é‡‘<rt>ã—ãã‚“</rt></ruby>ãŒ<ruby>è¶³<rt>ãŸ</rt></ruby>ã‚Šã¾ã›ã‚“ï¼</span><br>
                <ruby>ä¸‹<rt>ã—ãŸ</rt></ruby>ã®ãƒ—ãƒ©ãƒ³ã‚’<ruby>ç¢ºèª<rt>ã‹ãã«ã‚“</rt></ruby>ã—ã¦ã­
            </div>
        </div>
    </div>

    <div class="box plan">
        <label>ã€ã‚ã‚‰ã—ã¹<ruby>é•·è€…<rt>ã¡ã‚‡ã†ã˜ã‚ƒ</rt></ruby>ãƒ—ãƒ©ãƒ³ã€‘</label>
        <div class="result-card">
            <div class="highlight-box plan-style plan-empty" id="planOutput">
                <div class="empty-msg">
                    <ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>ãƒ»
                    <ruby>å£²å€¤<rt>ã†ã‚Šã­</rt></ruby>ãƒ»
                    <ruby>è²¯é‡‘<rt>ã¡ã‚‡ãã‚“</rt></ruby>ã‚’<ruby>å…¥<rt>ã„</rt></ruby>ã‚Œã¦ã­
                </div>
            </div>
        </div>
    </div>

    <div class="box atm">
        <label>ã€ATM <ruby>å…¥é‡‘è£œåŠ©<rt>ã«ã‚…ã†ãã‚“ã»ã˜ã‚‡</rt></ruby>ã€‘</label>
        <div class="input-group">
            <p class="sub-text">99,000ãƒ™ãƒ« Ã— <ruby>è¢‹æ•°<rt>ãµãã‚ã™ã†</rt></ruby></p>
            <input type="text" id="bags" placeholder="è¢‹æ•°" class="comma-input">
        </div>
        <div class="result-card">
            <ruby>å…¥é‡‘åˆè¨ˆ<rt>ã«ã‚…ã†ãã‚“ã”ã†ã‘ã„</rt></ruby>ï¼š<span id="atmTotal" style="color:#673ab7; font-size:1.3em;">0</span> ãƒ™ãƒ«
        </div>
    </div>

    <div class="box memo">
        <label>ã€ğŸ“ãƒ¡ãƒ¢ã€‘</label>

        <div class="auto-box">
            <div class="memo-mini">
                <b><ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>ã«<ruby>å¿…è¦<rt>ã²ã¤ã‚ˆã†</rt></ruby>ãªãƒ™ãƒ«<ruby>è¢‹<rt>ã¶ãã‚</rt></ruby>ã®<ruby>æ•°<rt>ã‹ãš</rt></ruby>ï¼ˆ<ruby>æ”¯æ‰•é¡<rt>ã—ã¯ã‚‰ã„ãŒã</rt></ruby>ï¼‰ï¼š</b><br>
                <span class="mono"><span id="autoBags">0</span></span> <ruby>è¢‹<rt>ãµãã‚</rt></ruby> ï¼‹
                <span class="mono"><span id="autoRemainder">0</span></span> ãƒ™ãƒ«
                ï¼ˆ<ruby>æ”¯æ‰•é¡åˆè¨ˆ<rt>ã—ã¯ã‚‰ã„ãŒãã”ã†ã‘ã„</rt></ruby>ï¼š<span class="mono"><span id="autoCostTotal">0</span></span> ãƒ™ãƒ«ï¼‰
            </div>
            <div style="margin-top:8px;" class="memo-row">
                <button class="btn primary" id="copyToMemo" type="button">ã“ã®<ruby>å†…å®¹<rt>ãªã„ã‚ˆã†</rt></ruby>ã‚’ãƒ¡ãƒ¢ã«<ruby>å…¥<rt>ã„</rt></ruby>ã‚Œã‚‹</button>
            </div>
        </div>

        <div style="height:12px;"></div>

        <div class="memo-mini"><b><ruby>ä½•å¾€å¾©<rt>ãªã‚“ãŠã†ãµã</rt></ruby>ã—ãŸã‹</b></div>
        <div class="memo-row" style="margin-top:6px;">
            <div class="counter">
                <span class="memo-mini"><b><ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>ï¼š</b></span>
                <button class="btn small" id="buyTripMinus" type="button">âˆ’</button>
                <div class="val"><span id="buyTripCount">0</span></div>
                <button class="btn small" id="buyTripPlus" type="button">ï¼‹</button>
                <button class="btn small danger" id="buyTripReset" type="button"><ruby>æ¶ˆ<rt>ã‘</rt></ruby>ã™</button>
            </div>
        </div>

        <div class="memo-row" style="margin-top:10px;">
            <div class="counter">
                <span class="memo-mini"><b><ruby>å£²å€¤<rt>ã†ã‚Šã­</rt></ruby>ï¼š</b></span>
                <button class="btn small" id="sellTripMinus" type="button">âˆ’</button>
                <div class="val"><span id="sellTripCount">0</span></div>
                <button class="btn small" id="sellTripPlus" type="button">ï¼‹</button>
                <button class="btn small danger" id="sellTripReset" type="button"><ruby>æ¶ˆ<rt>ã‘</rt></ruby>ã™</button>
            </div>
        </div>

        <div style="height:12px;"></div>

        <div class="memo-mini"><ruby>ãƒ™ãƒ«è¢‹<rt>ã¹ã‚‹ã¶ãã‚</rt></ruby>ãƒ¡ãƒ¢</div>
        <textarea id="bagMemo" rows="2" placeholder="ä¾‹ï¼šè²·å€¤ã«å¿…è¦ãªãƒ™ãƒ«è¢‹ã®æ•°ï¼š2è¢‹ï¼‹76,400ãƒ™ãƒ«ï¼ˆæ”¯æ‰•é¡åˆè¨ˆï¼š178,200ãƒ™ãƒ«ï¼‰"></textarea>

        <div style="height:12px;"></div>

        <div class="memo-mini"><ruby>ãƒ¡ãƒ¢<rt>ã‚ã‚‚</rt></ruby></div>
        <textarea id="freeMemo" rows="4" placeholder="ä¾‹ï¼šä»Šæ—¥ã¯å£²å€¤660ã€è²·å€¤3å¾€å¾©ã€å£²å€¤2å¾€å¾©"></textarea>

        <div style="height:12px;"></div>
        <div class="memo-row">
            <button class="btn danger" id="clearMemoAll" type="button"><ruby>ãƒ¡ãƒ¢<rt>ã‚ã‚‚</rt></ruby>ã‚’<ruby>å…¨æ¶ˆå»<rt>ãœã‚“ã—ã‚‡ã†ãã‚‡</rt></ruby></button>
        </div>
    </div>
</div>

<script>
const COOKIE_KEY = "kabutool_state_v4";

function setCookie(name, value, days){
    const d = new Date();
    d.setTime(d.getTime() + (days*24*60*60*1000));
    document.cookie = name + "=" + encodeURIComponent(value) + "; expires=" + d.toUTCString() + "; path=/; SameSite=Lax";
}
function getCookie(name){
    const target = name + "=";
    const parts = document.cookie.split("; ");
    for(const p of parts){
        if(p.indexOf(target) === 0) return decodeURIComponent(p.substring(target.length));
    }
    return "";
}
function loadState(){
    const raw = getCookie(COOKIE_KEY);
    if(!raw) return null;
    try { return JSON.parse(raw); } catch(e){ return null; }
}
function saveState(partial){
    const current = loadState() || {};
    const next = { ...current, ...partial, _savedAt: Date.now() };
    setCookie(COOKIE_KEY, JSON.stringify(next), 365);
}

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ */
let isComposing = false;
document.querySelectorAll('.comma-input').forEach(input => {
    input.addEventListener('compositionstart', () => { isComposing = true; });
    input.addEventListener('compositionend', function() { isComposing = false; formatAndCalc(this); });
    input.addEventListener('input', function() { if (!isComposing) { formatAndCalc(this); } });
});

function formatAndCalc(el) {
    let cursor = el.selectionStart;
    let originalLen = el.value.length;
    let val = el.value.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
    let rawVal = val.replace(/[^0-9]/g, '');
    el.value = rawVal !== "" ? Number(rawVal).toLocaleString() : "";
    let newLen = el.value.length;
    el.setSelectionRange(cursor + (newLen - originalLen), cursor + (newLen - originalLen));

    /* å…¥åŠ›å€¤ã‚’Cookieä¿å­˜ï¼ˆè¨ˆç®—å‰ã§ã‚‚ä¿å­˜ï¼‰ */
    persistInputs();

    calc();
}

function parseNumber(str) {
    return Number((str || "").replace(/,/g, '')) || 0;
}

function setPlanEmptyState(isEmpty){
    const plan = document.getElementById('planOutput');
    if(isEmpty){
        plan.classList.add('plan-empty');
    }else{
        plan.classList.remove('plan-empty');
    }
}

/* å…¥åŠ›ç³»ã‚’ä¿å­˜ */
function persistInputs(){
    saveState({
        buyPrice: document.getElementById('buyPrice').value,
        sellPrice: document.getElementById('sellPrice').value,
        rows: document.getElementById('rows').value,
        slots: document.getElementById('slots').value,
        currentBank: document.getElementById('currentBank').value,
        targetBank: document.getElementById('targetBank').value,
        bags: document.getElementById('bags').value
    });
}

/* ãƒ¡ãƒ¢UI */
const bagMemoEl = document.getElementById("bagMemo");
const freeMemoEl = document.getElementById("freeMemo");

const autoBagsEl = document.getElementById("autoBags");
const autoRemEl  = document.getElementById("autoRemainder");
const autoCostEl = document.getElementById("autoCostTotal");

const buyTripEl  = document.getElementById("buyTripCount");
const sellTripEl = document.getElementById("sellTripCount");

function clampInt(v){ return Math.max(0, Math.floor(Number(v) || 0)); }

function setCounter(el, key, v){
    const n = clampInt(v);
    el.textContent = n.toLocaleString();
    saveState({ [key]: n });
}
function getCounter(el){
    return parseNumber(el.textContent);
}

/* è²·å€¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
document.getElementById("buyTripPlus").addEventListener("click", () => setCounter(buyTripEl, "buyTripCount", getCounter(buyTripEl) + 1));
document.getElementById("buyTripMinus").addEventListener("click", () => setCounter(buyTripEl, "buyTripCount", getCounter(buyTripEl) - 1));
document.getElementById("buyTripReset").addEventListener("click", () => setCounter(buyTripEl, "buyTripCount", 0));

/* å£²å€¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
document.getElementById("sellTripPlus").addEventListener("click", () => setCounter(sellTripEl, "sellTripCount", getCounter(sellTripEl) + 1));
document.getElementById("sellTripMinus").addEventListener("click", () => setCounter(sellTripEl, "sellTripCount", getCounter(sellTripEl) - 1));
document.getElementById("sellTripReset").addEventListener("click", () => setCounter(sellTripEl, "sellTripCount", 0));

/* ãƒ¡ãƒ¢ä¿å­˜ */
bagMemoEl.addEventListener("input", () => saveState({ bagMemo: bagMemoEl.value }));
freeMemoEl.addEventListener("input", () => saveState({ freeMemo: freeMemoEl.value }));

/* è‡ªå‹•å€¤ã‚’ãƒ¡ãƒ¢ã¸ */
document.getElementById("copyToMemo").addEventListener("click", () => {
    const bags = autoBagsEl.textContent;
    const rem  = autoRemEl.textContent;
    const total = autoCostEl.textContent;
    const text = `è²·å€¤ã«å¿…è¦ãªãƒ™ãƒ«è¢‹ã®æ•°ï¼š${bags}è¢‹ï¼‹${rem}ãƒ™ãƒ«ï¼ˆæ”¯æ‰•é¡åˆè¨ˆï¼š${total}ãƒ™ãƒ«ï¼‰`;
    bagMemoEl.value = text;
    saveState({ bagMemo: text });
});

/* å…¨æ¶ˆå»ï¼ˆãƒ¡ãƒ¢ã ã‘ï¼‰ */
document.getElementById("clearMemoAll").addEventListener("click", () => {
    bagMemoEl.value = "";
    freeMemoEl.value = "";
    setCounter(buyTripEl,  "buyTripCount", 0);
    setCounter(sellTripEl, "sellTripCount", 0);
    saveState({ bagMemo: "", freeMemo: "", buyTripCount: 0, sellTripCount: 0 });
});

/* æ—¢å­˜ï¼šè¨ˆç®— */
function calc() {
    const buyVal = document.getElementById('buyPrice').value;
    const sellVal = document.getElementById('sellPrice').value;
    const rowsInput = document.getElementById('rows');
    const slotsInput = document.getElementById('slots');
    const bankVal = document.getElementById('currentBank').value;
    const targetVal = document.getElementById('targetBank').value;
    const bagsVal = document.getElementById('bags').value;
    const maxAlert = document.getElementById('maxAlert');

    let rows = parseNumber(rowsInput.value);
    let slots = parseNumber(slotsInput.value);

    if (rows >= 4) {
        rows = 4;
        rowsInput.value = "4";
        slots = 0;
        slotsInput.value = "";
        slotsInput.disabled = true;
        maxAlert.style.display = "block";
    } else {
        slotsInput.disabled = false;
        maxAlert.style.display = "none";
        if (slots > 9) {
            slots = 9;
            slotsInput.value = "9";
        }
    }

    const bPrice = parseNumber(buyVal);
    const sPrice = parseNumber(sellVal);
    const currentBank = parseNumber(bankVal);
    const targetBank = targetVal === "" ? 0 : parseNumber(targetVal);
    const bags = parseNumber(bagsVal);

    const totalCapacitySlots = (rows * 10) + slots;
    const capacityStocks = totalCapacitySlots * 100;
    const costCurrent = capacityStocks * bPrice;

    document.getElementById('currentCapacityText').innerText = totalCapacitySlots;
    document.getElementById('totalStocks').innerText = capacityStocks.toLocaleString();
    document.getElementById('targetStocks').innerText = capacityStocks.toLocaleString();
    document.getElementById('cost').innerText = costCurrent.toLocaleString();
    document.getElementById('sales').innerText = (capacityStocks * sPrice).toLocaleString();
    document.getElementById('profit').innerText = ((sPrice - bPrice) * capacityStocks).toLocaleString();
    document.getElementById('atmTotal').innerText = (bags * 99000).toLocaleString();

    const needed = Math.max(0, targetBank - currentBank);
    document.getElementById('neededAmount').innerText = needed.toLocaleString();

    const autoBags = Math.floor(costCurrent / 99000);
    const autoRem  = costCurrent % 99000;
    autoBagsEl.textContent = autoBags.toLocaleString();
    autoRemEl.textContent  = autoRem.toLocaleString();
    autoCostEl.textContent = costCurrent.toLocaleString();

    let output = document.getElementById('planOutput');

    if (buyVal === "" || sellVal === "" || bankVal === "") {
        document.getElementById('tripDisplay').style.display = "grid";
        document.getElementById('tripAlert').style.display = "none";
        document.getElementById('tripsFull').innerText = "0";
        document.getElementById('tripsCurrent').innerText = "0";

        setPlanEmptyState(true);
        output.innerHTML = `
          <div class="empty-msg">
            <ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>ãƒ»
            <ruby>å£²å€¤<rt>ã†ã‚Šã­</rt></ruby>ãƒ»
            <ruby>è²¯é‡‘<rt>ã¡ã‚‡ãã‚“</rt></ruby>ã‚’<ruby>å…¥<rt>ã„</rt></ruby>ã‚Œã¦ã­
          </div>
        `;
        return;
    }

    setPlanEmptyState(false);

    if (sPrice > bPrice) {
        let tempBank = currentBank;
        let stepCount = 0;
        let log = "";

        while (tempBank < costCurrent && stepCount < 100) {
            stepCount++;
            let buyAmount = Math.floor(tempBank / bPrice);
            let profit = buyAmount * (sPrice - bPrice);
            if (stepCount <= 3) {
                log += `<li>${stepCount}<ruby>å›ç›®<rt>ã‹ã„ã‚</rt></ruby>ï¼š${buyAmount.toLocaleString()}ã‚«ãƒ–<ruby>è³¼å…¥<rt>ã“ã†ã«ã‚…ã†</rt></ruby></li>`;
            }
            tempBank += profit;
        }

        if (stepCount > 0) {
            document.getElementById('tripDisplay').style.display = "none";
            document.getElementById('tripAlert').style.display = "block";
        } else {
            document.getElementById('tripDisplay').style.display = "grid";
            document.getElementById('tripAlert').style.display = "none";
            document.getElementById('tripsFull').innerText = Math.ceil(needed / ((sPrice - bPrice) * 4000)).toLocaleString();
            document.getElementById('tripsCurrent').innerText = Math.ceil(needed / ((sPrice - bPrice) * capacityStocks)).toLocaleString();
        }

        let message = `<div><b>ã‚«ãƒãƒ³(${totalCapacitySlots}ãƒã‚¹)</b>ã‚’<ruby>æº€ã‚¿ãƒ³<rt>ã¾ã‚“ãŸã‚“</rt></ruby>ã«ã™ã‚‹<ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby>ï¼š</div>`;

        if (stepCount === 0) {
          message += `<div style="margin:10px 0;">
            <b class="blue-val">1<ruby>å›ç›®<rt>ã‹ã„ã‚</rt></ruby>ã‹ã‚‰ã‚«ãƒãƒ³ã‚’<ruby>æº€ã‚¿ãƒ³<rt>ã¾ã‚“ãŸã‚“</rt></ruby>ã«ã§ãã¾ã™ï¼</b>
          </div>`;
        } else {
          message += `<ul class="step-list">${log}</ul>`;

          if (stepCount > 3) {
            message += `
              <div class="step-note">...ã‚ã¨ ${stepCount - 3} <ruby>å›<rt>ã‹ã„</rt></ruby>ã®<ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby> ...</div>
              <div class="step-note">ï¼ˆ3<ruby>å›ç›®<rt>ã‹ã„ã‚</rt></ruby>ã¨<ruby>åŒ<rt>ãŠãª</rt></ruby>ã˜ã‚ˆã†ã«<ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby>ã—ã¦<ruby>è³‡é‡‘<rt>ã—ãã‚“</rt></ruby>ã‚’<ruby>è²¯<rt>ãŸ</rt></ruby>ã‚ã¾ã™ï¼‰</div>
            `;
          }

          message += `<div>
            ã‚ã¨ <b class="red-val">${stepCount}</b> <ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby>ã§ã‚«ãƒãƒ³ãŒã„ã£ã±ã„ã«ãªã‚Šã¾ã™ã€‚
          </div>`;
        }

        let remainingNeeded = Math.max(0, targetBank - tempBank);
        let finalTrips = Math.ceil(remainingNeeded / ((sPrice - bPrice) * capacityStocks));

        message += `<div style="margin-top:10px; border-top:1px solid #00897b; padding-top:10px;">
          <ruby>ç›®æ¨™é”æˆ<rt>ã‚‚ãã²ã‚‡ã†ãŸã£ã›ã„</rt></ruby>ã¾ã§ã•ã‚‰ã« <b class="red-val">${finalTrips}</b> <ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby>ã€<br>
          <ruby>åˆè¨ˆ<rt>ã”ã†ã‘ã„</rt></ruby>ã§ <b style="font-size:1.4em;">${stepCount + finalTrips}</b> <ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby><ruby>å¿…è¦<rt>ã²ã¤ã‚ˆã†</rt></ruby>ã§ã™ã€‚
        </div>`;

        output.innerHTML = message;

    } else {
        output.innerText = "å£²å€¤ã¯è²·å€¤ã‚ˆã‚Šé«˜ãè¨­å®šã—ã¦ãã ã•ã„ã€‚";
    }
}

/* ãµã‚ŠãŒãª ON/OFFï¼ˆä¿å­˜ã¤ãï¼‰ */
const rubyBtn = document.getElementById('rubyToggle');
rubyBtn.addEventListener('click', () => {
    document.body.classList.toggle('no-ruby');
    const off = document.body.classList.contains('no-ruby');
    rubyBtn.textContent = off ? 'ãµã‚ŠãŒãªï¼šOFF' : 'ãµã‚ŠãŒãªï¼šON';
    saveState({ rubyOff: off });
});

/* åˆæœŸå¾©å…ƒï¼šå…¥åŠ›å€¤ï¼‹ãƒ¡ãƒ¢ï¼‹å¾€å¾©æ•°ï¼‹ãµã‚ŠãŒãª */
(function initFromCookie(){
    const st = loadState();
    if(!st) { calc(); return; }

    if(st.rubyOff){
        document.body.classList.add('no-ruby');
        rubyBtn.textContent = 'ãµã‚ŠãŒãªï¼šOFF';
    }

    /* å…¥åŠ›å€¤ã®å¾©å…ƒï¼ˆç›®æ¨™é‡‘é¡ã‚‚å«ã‚€ï¼‰ */
    const map = [
        ["buyPrice","buyPrice"],
        ["sellPrice","sellPrice"],
        ["rows","rows"],
        ["slots","slots"],
        ["currentBank","currentBank"],
        ["targetBank","targetBank"],
        ["bags","bags"],
    ];
    for(const [id,key] of map){
        if(typeof st[key] === "string"){
            const el = document.getElementById(id);
            el.value = st[key];
        }
    }

    if(typeof st.buyTripCount === "number")  buyTripEl.textContent  = st.buyTripCount.toLocaleString();
    if(typeof st.sellTripCount === "number") sellTripEl.textContent = st.sellTripCount.toLocaleString();

    if(typeof st.bagMemo === "string")  bagMemoEl.value = st.bagMemo;
    if(typeof st.freeMemo === "string") freeMemoEl.value = st.freeMemo;

    calc();
})();
</script>
</body>
</html>
