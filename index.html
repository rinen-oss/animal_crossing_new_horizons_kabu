<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚ã¤æ£®ï½œã‚«ãƒ–ä¾¡è¨ˆç®—ãƒ»åˆ©ç›Šè¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#fdfae6;
      --text:#4a3c31;
      --accent:#789440;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    body{font-family:'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding:20px;margin:0;}
    body.no-ruby rt{display:none;}
    .container{background:#fff;padding:25px;border-radius:20px;box-shadow:var(--shadow);width:100%;max-width:480px;box-sizing:border-box;}
    h2{text-align:center;color:var(--accent);margin:6px 0 18px;line-height:1.25;font-size:1.22em;letter-spacing:.01em;}
    #rubyToggle{display:block;margin:0 auto 15px;padding:6px 14px;border-radius:999px;border:1px solid var(--accent);background:#fff;cursor:pointer;font-size:.85em;line-height:1.2;}
    .box{margin-bottom:15px;padding:20px;border-radius:15px;border-left:12px solid;box-sizing:border-box;}
    .buy{border-color:#ffd54f;background:#fffde7;}
    .sell{border-color:#81c784;background:#f1f8e9;}
    .goal{border-color:#ff8a65;background:#fff3e0;}
    .plan{border-color:#4db6ac;background:#e0f2f1;}
    .atm{border-color:#d1c4e9;background:#f3e5f5;}
    .memo{border-color:#90a4ae;background:#eceff1;}
    .input-group{margin-bottom:14px;}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    .header-left{display:flex;flex-wrap:wrap;align-items:baseline;gap:8px;font-size:1.05em;font-weight:800;line-height:1.25;}
    .header-sub{font-size:.72em;font-weight:400;opacity:.85;}
    ruby{font-style:normal;line-height:1.15;ruby-position:over;ruby-align:center;}
    rt{font-size:.55em;font-weight:400;line-height:1;}
    .sub-text{font-size:.85em;color:#795548;margin:0 0 6px;line-height:1.25;}
    input[type="text"]{width:100%;padding:12px;border:2px solid #eee;border-radius:12px;font-size:18px;outline:none;background:#fff;color:var(--text);text-align:right;box-sizing:border-box;line-height:1.2;}
    input[type="text"]:focus{border-color:var(--accent);}
    input[type="text"]:disabled{background:#eceff1;color:transparent;border-color:#cfd8dc;cursor:not-allowed;}
    input[type="text"]:disabled::placeholder{color:transparent;}
    ::placeholder{color:#ccc;opacity:1;}
    textarea{width:100%;border:2px solid #e0e0e0;border-radius:12px;padding:10px 12px;font-size:14px;line-height:1.5;resize:vertical;background:#fff;color:var(--text);outline:none;box-sizing:border-box;}
    textarea:focus{border-color:#90a4ae;}
    .result-card{background:#fff;padding:14px;border-radius:12px;margin-top:10px;font-weight:700;line-height:1.55;box-sizing:border-box;border:1px solid rgba(0,0,0,.05);}
    .red-val{color:#d32f2f;font-size:1.25em;}
    .blue-val{color:#03a9f4;}
    .separator{font-size:1.2em;font-weight:800;margin:0 10px;color:#795548;}
    .cap-row{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;}
    .cap-row .cap-input{width:84px;min-width:72px;max-width:96px;}
    .cap-unit{font-size:.85em;white-space:nowrap;}
    #maxAlert{color:#d32f2f;font-size:.75em;margin-top:6px;display:none;font-weight:800;line-height:1.2;}
    .btn{border:1px solid #90a4ae;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:.9em;white-space:nowrap;line-height:1.1;touch-action:manipulation;}
    .btn.small{padding:7px 12px;border-radius:999px;}
    .btn.primary{border-color:#607d8b;}
    .btn.danger{border-color:#c62828;color:#c62828;}
    .trip-compare{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .highlight-box{background:#fff9c4;padding:10px;border-radius:8px;text-align:center;border:2px dashed #ffb300;display:flex;flex-direction:column;justify-content:center;min-height:80px;box-sizing:border-box;line-height:1.25;}
    .highlight-box.small{background:#f0f4c3;border-color:#afb42b;}
    .trip-num{font-size:1.35em;color:#e64a19;display:block;}
    .capacity-label{font-size:.75em;color:#558b2f;margin-top:2px;}
    #tripAlert{background:#ffecb3;border-color:#ffa000;text-align:center;padding:14px;border-radius:12px;border:2px dashed #ffa000;margin-top:10px;line-height:1.45;display:none;box-sizing:border-box;}
    .plan .result-card{padding:12px;}
    .plan-style{background:#b2dfdb;border:2px dashed #00897b;border-radius:12px;padding:12px 14px;width:100%;box-sizing:border-box;text-align:left;line-height:1.35;overflow:hidden;word-break:normal;overflow-wrap:anywhere;}
    #planOutput ul{margin:8px 0 0;padding-left:1.15em;}
    #planOutput li{margin:2px 0;line-height:1.35;}
    #planOutput .plan-hr{border:0;border-top:1px solid rgba(0,137,123,.35);margin:10px 0;}
    #planOutput.plan-empty{display:flex;align-items:center;min-height:70px;}
    #planOutput .empty-msg{white-space:normal;line-height:1.5;}

    /* å¯¾ä¾¡ï¼ˆæ å†…ã§å®Œçµï¼‰ */
    .reward-box{ margin-top:10px; padding:12px; border-radius:12px; border:2px dashed rgba(0,0,0,.12); background:#fff; box-sizing:border-box; }
    .reward-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .reward-head-left{ display:flex;align-items:center;gap:10px;flex-wrap:wrap; }
    .reward-head input[type="checkbox"]{ width:20px;height:20px;accent-color:var(--accent);cursor:pointer;flex:0 0 auto; }
    .reward-title{ font-weight:900; user-select:none; cursor:pointer; line-height:1.25; }
    .reward-panel{display:none;margin-top:10px;}
    .reward-panel.open{display:block;}
    .reward-item{ border:2px dashed rgba(120,148,64,.28); background:#fbfff1; border-radius:12px; padding:10px 12px; box-sizing:border-box; margin-top:8px; }
    .reward-item-head{ display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap; }
    .reward-item-left{ display:flex;align-items:center;gap:10px;flex-wrap:wrap; }
    .reward-item-head input[type="checkbox"]{ width:20px;height:20px;accent-color:var(--accent);cursor:pointer;flex:0 0 auto; }
    .reward-item .label{ font-weight:900; user-select:none; cursor:pointer; }
    .reward-item.filled{border-color:rgba(120,148,64,.55);background:#f4ffe2;}
    .reward-fields{margin-top:8px;display:none;}
    .reward-fields.open{display:block;}
    .reward-smallnote{margin-top:8px;font-size:.86em;color:#6d4c41;line-height:1.45;opacity:.92;}

    /* è²·å€¤ï¼šå¯¾ä¾¡ï¼ˆãƒ™ãƒ«ï¼‰æ”¯æ‰•ã‚ã‚Šã®å ´åˆï¼ˆãƒ™ãƒ«å…¥åŠ›ãŒã‚ã‚‹æ™‚ã ã‘è¡¨ç¤ºï¼‰ */
    .reward-result{
      display:none;
      margin-top:10px;
      padding:12px;
      border-radius:12px;
      border:2px dashed rgba(255,183,0,.55);
      background:#fff;
      box-sizing:border-box;
      line-height:1.55;
    }
    .reward-result.open{display:block;}

    /* ATM */
    .atm-note{font-size:.9em;color:#5e35b1;line-height:1.5;margin-top:8px;font-weight:700;}
    .atm-note-sub{font-weight:400;}
    .atm-line{margin-top:8px;padding:10px 12px;background:#fff;border-radius:12px;border:2px dashed #d1c4e9;line-height:1.55;box-sizing:border-box;}
    .atm-subline{margin-top:8px;padding-top:8px;border-top:1px dashed rgba(103,58,183,.25);font-size:.92em;color:#4a148c;line-height:1.55;display:none;}
    .atm-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(103,58,183,.35);background:#f7f2ff;font-size:.9em;line-height:1.2;margin:6px 8px 0 0;max-width:100%;box-sizing:border-box;}
    .atm-chip b{font-weight:900;}
    .atm-chip .mono{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .memo-mini{font-size:.92em;color:#455a64;line-height:1.5;}
    .memo-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .memo-white{background:#fff;border-radius:12px;border:2px dashed #c0c6cc;padding:10px 12px;box-sizing:border-box;}
    .counter{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .counter .val{min-width:64px;text-align:center;font-size:1.2em;color:#37474f;font-weight:800;background:#fff;border:2px dashed #90a4ae;border-radius:12px;padding:6px 10px;box-sizing:border-box;}
    .shortcut-box{margin-top:12px;background:#fff;border-radius:12px;border:2px dashed #90a4ae;padding:12px;box-sizing:border-box;}
    .shortcut-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    .shortcut-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .shortcut-item{border:1px solid rgba(0,0,0,.10);border-radius:12px;padding:10px;background:#fafafa;box-sizing:border-box;}
    .shortcut-top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;}
    .dir{font-weight:900;font-size:1.05em;white-space:nowrap;}
    .tool-view{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .tool-img{width:34px;height:34px;object-fit:contain;background:#fff;border-radius:8px;border:1px solid rgba(0,0,0,.08);padding:4px;box-sizing:border-box;}
    select{width:100%;padding:10px 12px;border-radius:12px;border:2px solid #e0e0e0;background:#fff;font-size:14px;box-sizing:border-box;outline:none;}
    select:focus{border-color:#90a4ae;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}

    /* ç›®æ¨™ï¼šãƒ©ãƒ™ãƒ«è¡Œã«ä½™ç™½ï¼ˆå…¥åŠ›ã¨ãƒœã‚¿ãƒ³ãŒè©°ã¾ã‚‹ã®ã‚’é˜²ãï¼‰ */
    .goal .input-group .memo-row{margin-bottom:10px;}
    .goal .input-group .memo-row .btn{margin-top:4px;}

    /* ãµã‚ŠãŒãªOFFæ™‚ï¼šè¦‹å‡ºã—ã®å¤‰ãªç©ºç™½ã‚’æ¶ˆã™ï¼ˆã€ç›®æ¨™é”æˆ ã¸ã® é“ã€‘ç­‰ï¼‰ */
    body.no-ruby .header-left{gap:0;}
    body.no-ruby .header-left .header-sub{margin-left:6px;}
    body.no-ruby .goal .header-left,
    body.no-ruby .plan .header-left{
      letter-spacing:0;
      word-spacing:0;
      gap:0;
    }
    body.no-ruby .goal .header-left ruby,
    body.no-ruby .plan .header-left ruby{ margin-right:0; }

    @media (max-width:430px){
      .header-row{flex-direction:column;align-items:flex-start;gap:8px;}
      .header-row .btn{align-self:flex-start;}
      .goal .memo-row{flex-direction:column;align-items:flex-start;gap:8px;}
      .goal .memo-row .btn{align-self:flex-start;}

      /* ===== iPhoneè¦‹åˆ‡ã‚Œå¯¾ç­–ï¼ˆã“ã“ã ã‘è¿½åŠ ãƒ»ä»–ã¯è§¦ã‚‰ãªã„ï¼‰ ===== */
      .cap-row .cap-input{
        width:auto;
        min-width:0;
        max-width:none;
        flex:1 1 0;
      }
      /* =========================================================== */
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ã‚«ãƒ–ä¾¡è¨ˆç®—ãƒ»åˆ©ç›Šè¨ˆç®—ãƒ„ãƒ¼ãƒ«</h2>
    <button id="rubyToggle" type="button">ãµã‚ŠãŒãªï¼šON</button>

    <!-- è²·å€¤ -->
    <div class="box buy">
      <div class="header-row">
        <div class="header-left">
          <ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>
          <span class="header-sub">ï¼ˆã‚«ãƒ–ã‚’<ruby>è²·<rt>ã‹</rt></ruby>ã†<ruby>å€¤æ®µ<rt>ã­ã ã‚“</rt></ruby>ï¼‰</span>
        </div>
        <button class="btn small danger" id="clearBuy" type="button"><ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="input-group">
        <p class="sub-text">1ã‚«ãƒ–ã®<ruby>å€¤æ®µ<rt>ã­ã ã‚“</rt></ruby></p>
        <input type="text" id="buyPrice" placeholder="90" class="comma-input" inputmode="numeric" />
      </div>

      <div class="input-group">
        <p class="sub-text">æŒã¦ã‚‹<ruby>é‡<rt>ã‚Šã‚‡ã†</rt></ruby>ï¼ˆ1<ruby>åˆ—<rt>ã‚Œã¤</rt></ruby>ï¼10ãƒã‚¹ / <ruby>æœ€å¤§<rt>ã•ã„ã ã„</rt></ruby>4<ruby>åˆ—<rt>ã‚Œã¤</rt></ruby>ï¼‰</p>
        <div class="cap-row">
          <input type="text" id="rows" placeholder="2" class="comma-input cap-input" inputmode="numeric" />
          <span class="cap-unit"><ruby>åˆ—<rt>ã‚Œã¤</rt></ruby></span>
          <span class="separator">ï¼‹</span>
          <input type="text" id="slots" placeholder="5" class="comma-input cap-input" inputmode="numeric" />
          <span class="cap-unit">ãƒã‚¹</span>
        </div>
        <div id="maxAlert">â€»4<ruby>åˆ—<rt>ã‚Œã¤</rt></ruby>ï¼ˆ40ãƒã‚¹ï¼‰ãŒ<ruby>æœ€å¤§<rt>ã•ã„ã ã„</rt></ruby>ã§ã™</div>
      </div>

      <div class="result-card" id="buyBaseResult">
        <ruby>åˆè¨ˆ<rt>ã”ã†ã‘ã„</rt></ruby>ï¼š<span id="totalStocks">0</span> ã‚«ãƒ–<br />
        <ruby>æ”¯æ‰•é¡<rt>ã—ã¯ã‚‰ã„ãŒã</rt></ruby>ï¼š<span id="cost" class="red-val">0</span> ãƒ™ãƒ«<br />
        <span class="memo-mini">
          <ruby>æ”¯æ‰•<rt>ã—ã¯ã‚‰</rt></ruby>ã®ãƒ™ãƒ«<ruby>è¢‹è¡¨è¨˜<rt>ã¶ãã‚ã²ã‚‡ã†ã</rt></ruby>ï¼š<span class="mono"><span id="costBags">0è¢‹ï¼‹0ãƒ™ãƒ«</span></span>
        </span>

        <!-- ãƒ™ãƒ«å¯¾ä¾¡ãŒã‚ã‚‹æ™‚ã ã‘ -->
        <div class="reward-result" id="buyRewardResult">
          <!-- â˜…ã“ã“ã«ãµã‚ŠãŒãªã‚’ä»˜ä¸ -->
          <div style="font-weight:900;margin-bottom:6px;">
            <ruby>å¯¾ä¾¡<rt>ãŸã„ã‹</rt></ruby><ruby>æ”¯æ‰•<rt>ã—ã¯ã‚‰</rt></ruby>ã„ï¼ˆ<ruby>ãƒ™ãƒ«<rt>ã¹ã‚‹</rt></ruby>ï¼‰ã‚ã‚Šã®<ruby>å ´åˆ<rt>ã°ã‚ã„</rt></ruby>
          </div>
          <ruby>æ”¯æ‰•é¡<rt>ã—ã¯ã‚‰ã„ãŒã</rt></ruby>ï¼š<span id="costWithReward" class="red-val">0</span> ãƒ™ãƒ«<br />
          <span class="memo-mini">
            <ruby>æ”¯æ‰•<rt>ã—ã¯ã‚‰</rt></ruby>ã®ãƒ™ãƒ«<ruby>è¢‹è¡¨è¨˜<rt>ã¶ãã‚ã²ã‚‡ã†ã</rt></ruby>ï¼š<span class="mono"><span id="costWithRewardBags">0è¢‹ï¼‹0ãƒ™ãƒ«</span></span>
          </span>
        </div>
      </div>

      <!-- å¯¾ä¾¡ï¼ˆè²·ã†æ™‚ï¼‰ï¼šæ å†…ã§å®Œçµ -->
      <div class="reward-box">
        <div class="reward-head">
          <div class="reward-head-left">
            <input type="checkbox" id="buyRewardEnabled" />
            <!-- â˜…ã“ã“ã«ãµã‚ŠãŒãªã‚’ä»˜ä¸ -->
            <label class="reward-title" for="buyRewardEnabled">
              <ruby>å¯¾ä¾¡<rt>ãŸã„ã‹</rt></ruby><ruby>æ”¯æ‰•<rt>ã—ã¯ã‚‰</rt></ruby>ã„ãŒã‚ã‚‹<ruby>æ™‚<rt>ã¨ã</rt></ruby>â˜‘
            </label>
          </div>
        </div>

        <div class="reward-panel" id="buyRewardPanel">
          <!-- ãƒã‚¤ãƒã‚± -->
          <div class="reward-item" id="buyItemTickets">
            <div class="reward-item-head">
              <div class="reward-item-left">
                <input type="checkbox" id="buyChkTickets" />
                <label class="label" for="buyChkTickets">ãƒã‚¤ãƒã‚±</label>
              </div>
            </div>
            <div class="reward-fields" id="buyFieldsTickets">
              <p class="sub-text" style="margin-top:8px;"><b>ãƒã‚¤ãƒã‚±</b> â—¯<ruby>æš<rt>ã¾ã„</rt></ruby></p>
              <input type="text" id="buyRewardTickets" placeholder="0" class="comma-input" inputmode="numeric" />
            </div>
          </div>

          <!-- ãƒ™ãƒ« -->
          <div class="reward-item" id="buyItemBells">
            <div class="reward-item-head">
              <div class="reward-item-left">
                <input type="checkbox" id="buyChkBells" />
                <label class="label" for="buyChkBells"><ruby>ãƒ™ãƒ«<rt>ã¹ã‚‹</rt></ruby></label>
              </div>
            </div>
            <div class="reward-fields" id="buyFieldsBells">
              <p class="sub-text" style="margin-top:8px;"><b><ruby>ãƒ™ãƒ«<rt>ã¹ã‚‹</rt></ruby></b> â—¯<ruby>è¢‹<rt>ãµãã‚</rt></ruby> ï¼‹ â—¯ãƒ™ãƒ«</p>
              <div class="cap-row">
                <input type="text" id="buyRewardFullBags" placeholder="0" class="comma-input cap-input" inputmode="numeric" />
                <span class="cap-unit"><ruby>è¢‹<rt>ãµãã‚</rt></ruby></span>
                <span class="separator">ï¼‹</span>
                <input type="text" id="buyRewardBells" placeholder="0" class="comma-input cap-input" inputmode="numeric" />
                <span class="cap-unit">ãƒ™ãƒ«</span>
              </div>
            </div>
          </div>

          <!-- ä»–ã‚¢ã‚¤ãƒ†ãƒ  -->
          <div class="reward-item" id="buyItemOther">
            <div class="reward-item-head">
              <div class="reward-item-left">
                <input type="checkbox" id="buyChkOther" />
                <label class="label" for="buyChkOther">ä»–ã‚¢ã‚¤ãƒ†ãƒ </label>
              </div>
            </div>
            <div class="reward-fields" id="buyFieldsOther">
              <p class="sub-text" style="margin-top:8px;"><b>ä»–ã‚¢ã‚¤ãƒ†ãƒ </b></p>
              <textarea id="buyRewardOther" rows="2" placeholder="ä¾‹ï¼šé‡‘é‰±çŸ³Ã—2ã€å®¶å…·ã€ç´ æ ãªã©"></textarea>
            </div>
          </div>

          <div class="reward-smallnote">â€»ã“ã“ã¯ãƒ¡ãƒ¢ç”¨é€”ï¼ˆATMè£œåŠ©ã®å·®ã—å¼•ãå¯¾è±¡ã¯ã€Œå£²å€¤å´ã®ãƒ™ãƒ«ã€ã®ã¿ï¼‰</div>
        </div>
      </div>
    </div>

    <!-- å£²å€¤ -->
    <div class="box sell">
      <div class="header-row">
        <div class="header-left">
          <ruby>å£²å€¤<rt>ã†ã‚Šã­</rt></ruby>
          <span class="header-sub">ï¼ˆã‚«ãƒ–ã‚’<ruby>å£²<rt>ã†</rt></ruby>ã‚‹<ruby>å€¤æ®µ<rt>ã­ã ã‚“</rt></ruby>ï¼‰</span>
        </div>
        <button class="btn small danger" id="clearSell" type="button"><ruby>å£²å€¤<rt>ã†ã‚Šã­</rt></ruby>ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="input-group">
        <p class="sub-text">1ã‚«ãƒ–ã®<ruby>å€¤æ®µ<rt>ã­ã ã‚“</rt></ruby></p>
        <input type="text" id="sellPrice" placeholder="660" class="comma-input" inputmode="numeric" />
      </div>

      <!-- å¯¾ä¾¡ï¼ˆå£²ã‚‹æ™‚ï¼‰ï¼šæ å†…ã§å®Œçµ -->
      <div class="reward-box">
        <div class="reward-head">
          <div class="reward-head-left">
            <input type="checkbox" id="sellRewardEnabled" />
            <!-- â˜…ã“ã“ã«ãµã‚ŠãŒãªã‚’ä»˜ä¸ -->
            <label class="reward-title" for="sellRewardEnabled">
              <ruby>å¯¾ä¾¡<rt>ãŸã„ã‹</rt></ruby><ruby>æ”¯æ‰•<rt>ã—ã¯ã‚‰</rt></ruby>ã„ãŒã‚ã‚‹<ruby>æ™‚<rt>ã¨ã</rt></ruby>â˜‘
            </label>
          </div>
        </div>

        <div class="reward-panel" id="sellRewardPanel">
          <!-- ãƒã‚¤ãƒã‚± -->
          <div class="reward-item" id="sellItemTickets">
            <div class="reward-item-head">
              <div class="reward-item-left">
                <input type="checkbox" id="sellChkTickets" />
                <label class="label" for="sellChkTickets">ãƒã‚¤ãƒã‚±</label>
              </div>
            </div>
            <div class="reward-fields" id="sellFieldsTickets">
              <p class="sub-text" style="margin-top:8px;"><b>ãƒã‚¤ãƒã‚±</b> â—¯<ruby>æš<rt>ã¾ã„</rt></ruby></p>
              <input type="text" id="sellRewardTickets" placeholder="0" class="comma-input" inputmode="numeric" />
            </div>
          </div>

          <!-- ãƒ™ãƒ« -->
          <div class="reward-item" id="sellItemBells">
            <div class="reward-item-head">
              <div class="reward-item-left">
                <input type="checkbox" id="sellChkBells" />
                <label class="label" for="sellChkBells"><ruby>ãƒ™ãƒ«<rt>ã¹ã‚‹</rt></ruby>ï¼ˆATMè£œåŠ©ã§å·®ã—å¼•ãï¼‰</label>
              </div>
            </div>
            <div class="reward-fields" id="sellFieldsBells">
              <p class="sub-text" style="margin-top:8px;"><b><ruby>ãƒ™ãƒ«<rt>ã¹ã‚‹</rt></ruby></b> â—¯<ruby>è¢‹<rt>ãµãã‚</rt></ruby> ï¼‹ â—¯ãƒ™ãƒ«</p>
              <div class="cap-row">
                <input type="text" id="sellRewardFullBags" placeholder="0" class="comma-input cap-input" inputmode="numeric" />
                <span class="cap-unit"><ruby>è¢‹<rt>ãµãã‚</rt></ruby></span>
                <span class="separator">ï¼‹</span>
                <input type="text" id="sellRewardBells" placeholder="0" class="comma-input cap-input" inputmode="numeric" />
                <span class="cap-unit">ãƒ™ãƒ«</span>
              </div>
            </div>
          </div>

          <!-- ä»–ã‚¢ã‚¤ãƒ†ãƒ  -->
          <div class="reward-item" id="sellItemOther">
            <div class="reward-item-head">
              <div class="reward-item-left">
                <input type="checkbox" id="sellChkOther" />
                <label class="label" for="sellChkOther">ä»–ã‚¢ã‚¤ãƒ†ãƒ </label>
              </div>
            </div>
            <div class="reward-fields" id="sellFieldsOther">
              <p class="sub-text" style="margin-top:8px;"><b>ä»–ã‚¢ã‚¤ãƒ†ãƒ </b></p>
              <textarea id="sellRewardOther" rows="2" placeholder="ä¾‹ï¼šDIYãƒ¬ã‚·ãƒ”ã€ç´ æã€å®¶å…· ãªã©"></textarea>
            </div>
          </div>

          <div class="reward-smallnote">â€»ãƒã‚¤ãƒã‚±ã¨ä»–ã‚¢ã‚¤ãƒ†ãƒ ã¯è¡¨ç¤ºç”¨ï¼ˆATMå…¥é‡‘ç·é¡ã«åæ˜ ã—ãªã„ï¼‰</div>
        </div>
      </div>

      <div class="result-card">
        <span class="sub-text">â€»<span id="targetStocks">0</span> ã‚«ãƒ–<ruby>å£²å´æ™‚<rt>ã°ã„ãã‚ƒãã˜</rt></ruby></span><br />
        <ruby>å—å–é¡<rt>ã†ã‘ã¨ã‚ŠãŒã</rt></ruby>ï¼š<span id="sales" class="red-val">0</span> ãƒ™ãƒ«<br />
        <span class="blue-val"><ruby>åˆ©ç›Š<rt>ã‚Šãˆã</rt></ruby>ï¼šï¼‹ <span id="profit">0</span> ãƒ™ãƒ«</span><br />
        <span class="memo-mini">
          <ruby>å—å–<rt>ã†ã‘ã¨</rt></ruby>ã‚Šã®ãƒ™ãƒ«<ruby>è¢‹è¡¨è¨˜<rt>ã¶ãã‚ã²ã‚‡ã†ã</rt></ruby>ï¼š<span class="mono"><span id="salesBags">0è¢‹ï¼‹0ãƒ™ãƒ«</span></span>
        </span>
      </div>
    </div>

    <!-- ç›®æ¨™ -->
    <div class="box goal">
      <div class="header-left" style="margin-bottom:10px;">
        ã€<ruby>ç›®æ¨™é”æˆ<rt>ã‚‚ãã²ã‚‡ã†ãŸã£ã›ã„</rt></ruby>ã¸ã®<ruby>é“<rt>ã¿ã¡</rt></ruby>ã€‘
      </div>

      <div class="input-group">
        <div class="memo-row" style="justify-content:space-between;">
          <p class="sub-text" style="margin:0;"><ruby>ç¾åœ¨<rt>ã’ã‚“ã–ã„</rt></ruby>ã®<ruby>è²¯é‡‘é¡<rt>ã¡ã‚‡ãã‚“ãŒã</rt></ruby></p>
          <button class="btn small danger" id="clearCurrent" type="button"><ruby>ç¾åœ¨<rt>ã’ã‚“ã–ã„</rt></ruby>ã®<ruby>è²¯é‡‘é¡<rt>ã¡ã‚‡ãã‚“ãŒã</rt></ruby>ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
        <input type="text" id="currentBank" placeholder="0" class="comma-input" inputmode="numeric" />
      </div>

      <div class="input-group">
        <div class="memo-row" style="justify-content:space-between;">
          <p class="sub-text" style="margin:0;"><ruby>ç›®æ¨™<rt>ã‚‚ãã²ã‚‡ã†</rt></ruby>ã®<ruby>é‡‘é¡<rt>ãã‚“ãŒã</rt></ruby></p>
          <button class="btn small danger" id="clearTarget" type="button"><ruby>ç›®æ¨™<rt>ã‚‚ãã²ã‚‡ã†</rt></ruby>ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
        <input type="text" id="targetBank" placeholder="999,999,999" class="comma-input" inputmode="numeric" />
      </div>

      <div class="result-card">
        <ruby>ä¸è¶³é¡<rt>ãµãããŒã</rt></ruby>ï¼š<span id="neededAmount" class="red-val">0</span> ãƒ™ãƒ«
        <div id="tripDisplay" class="trip-compare">
          <div class="highlight-box">
            <span class="sub-text">ã‚«ãƒãƒ³<ruby>æœ€å¤§<rt>ã•ã„ã ã„</rt></ruby></span>
            <span class="capacity-label">(40ãƒã‚¹)</span>
            <span class="trip-num"><span id="tripsFull">0</span><ruby>å›<rt>ã‹ã„</rt></ruby></span>
          </div>
          <div class="highlight-box small">
            <span class="sub-text"><ruby>ä»Š<rt>ã„ã¾</rt></ruby>ã®<ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby></span>
            <span class="capacity-label">(ã‚«ãƒãƒ³<span id="currentCapacityText">0</span>ãƒã‚¹)</span>
            <span class="trip-num"><span id="tripsCurrent">0</span><ruby>å›<rt>ã‹ã„</rt></ruby></span>
          </div>
        </div>

        <div id="tripAlert">
          <span class="red-val" style="font-weight:900;"><ruby>è³‡é‡‘<rt>ã—ãã‚“</rt></ruby>ãŒ<ruby>è¶³<rt>ãŸ</rt></ruby>ã‚Šã¾ã›ã‚“ï¼</span><br />
          <ruby>ä¸‹<rt>ã—ãŸ</rt></ruby>ã®ãƒ—ãƒ©ãƒ³ã‚’<ruby>ç¢ºèª<rt>ã‹ãã«ã‚“</rt></ruby>ã—ã¦ã­
        </div>
      </div>
    </div>

    <!-- ã‚ã‚‰ã—ã¹ -->
    <div class="box plan">
      <div class="header-left" style="margin-bottom:10px;">ã€ã‚ã‚‰ã—ã¹<ruby>é•·è€…<rt>ã¡ã‚‡ã†ã˜ã‚ƒ</rt></ruby>ãƒ—ãƒ©ãƒ³ã€‘</div>
      <div class="result-card">
        <div class="plan-style plan-empty" id="planOutput">
          <div class="empty-msg">
            <ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>ãƒ»
            <ruby>å£²å€¤<rt>ã†ã‚Šã­</rt></ruby>ãƒ»
            <ruby>è²¯é‡‘<rt>ã¡ã‚‡ãã‚“</rt></ruby>ã‚’<ruby>å…¥<rt>ã„</rt></ruby>ã‚Œã¦ã­
          </div>
        </div>
      </div>
    </div>

    <!-- ATM -->
    <div class="box atm">
      <div class="header-left" style="margin-bottom:10px;">ã€ATM <ruby>å…¥é‡‘è£œåŠ©<rt>ã«ã‚…ã†ãã‚“ã»ã˜ã‚‡</rt></ruby>ã€‘</div>

      <div class="atm-note">
        <b>
          <ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby>ã®ã‚«ãƒãƒ³<ruby>æº€ã‚¿ãƒ³<rt>ã¾ã‚“ãŸã‚“</rt></ruby>ï¼ˆ<span id="atmCapacityText">0</span>ãƒã‚¹ï¼‰
          <ruby>è³¼å…¥<rt>ã“ã†ã«ã‚…ã†</rt></ruby>ã«<ruby>å±Š<rt>ã¨ã©</rt></ruby>ã<ruby>æ™‚<rt>ã¨ã</rt></ruby>ã ã‘<ruby>è¨ˆç®—<rt>ã‘ã„ã•ã‚“</rt></ruby>
        </b><br>
        <span class="atm-note-sub">
          â€»ã€ŒæŒã¦ã‚‹<ruby>é‡<rt>ã‚Šã‚‡ã†</rt></ruby>ï¼ˆ<ruby>åˆ—<rt>ã‚Œã¤</rt></ruby>ï¼‹ãƒã‚¹ï¼‰ã€ã®<ruby>å€¤<rt>ã‚ãŸã„</rt></ruby>ã§<ruby>æº€ã‚¿ãƒ³<rt>ã¾ã‚“ãŸã‚“</rt></ruby>ãŒ<ruby>æ±º<rt>ã</rt></ruby>ã¾ã‚Šã¾ã™<br>
          ï¼ˆ4<ruby>åˆ—<rt>ã‚Œã¤</rt></ruby>ãªã‚‰40ãƒã‚¹<ruby>å›ºå®š<rt>ã“ã¦ã„</rt></ruby>ï¼‰
        </span>
      </div>

      <div class="atm-line">
        <div><b>ATM<ruby>å…¥é‡‘ç·é¡<rt>ã«ã‚…ã†ãã‚“ãã†ãŒã</rt></ruby>ï¼ˆåŸºæº–ï¼‰ï¼š</b><span class="mono"><span id="atmSuggestTotal">0</span></span> ãƒ™ãƒ«</div>
        <div><b><ruby>å…¥é‡‘ç›®å®‰<rt>ã«ã‚…ã†ãã‚“ã‚ã‚„ã™</rt></ruby>ï¼ˆåŸºæº–ï¼‰ï¼š</b><span class="mono"><span id="atmSuggestBags">0è¢‹ï¼‹0ãƒ™ãƒ«</span></span></div>

        <div class="atm-subline" id="atmAdjustWrap">
          <div id="atmChipRow"></div>
          <div style="margin-top:6px;">
            <div><b>ATM<ruby>å…¥é‡‘ç·é¡<rt>ã«ã‚…ã†ãã‚“ãã†ãŒã</rt></ruby>ï¼ˆèª¿æ•´å¾Œï¼‰ï¼š</b><span class="mono"><span id="atmAdjustedTotal">0</span></span> ãƒ™ãƒ«</div>
            <div><b><ruby>å…¥é‡‘ç›®å®‰<rt>ã«ã‚…ã†ãã‚“ã‚ã‚„ã™</rt></ruby>ï¼ˆèª¿æ•´å¾Œï¼‰ï¼š</b><span class="mono"><span id="atmAdjustedBags">0è¢‹ï¼‹0ãƒ™ãƒ«</span></span></div>
          </div>
        </div>
      </div>

      <div class="input-group" style="margin-top:12px;">
        <p class="sub-text">99,000ãƒ™ãƒ« Ã— <ruby>è¢‹æ•°<rt>ãµãã‚ã™ã†</rt></ruby>ï¼ˆ<ruby>æ‰‹è¨ˆç®—ç”¨<rt>ã¦ã‘ã„ã•ã‚“ã‚ˆã†</rt></ruby>ï¼‰</p>
        <input type="text" id="bags" placeholder="è¢‹æ•°" class="comma-input" inputmode="numeric" />
      </div>

      <div class="result-card">
        <ruby>å…¥é‡‘åˆè¨ˆ<rt>ã«ã‚…ã†ãã‚“ã”ã†ã‘ã„</rt></ruby>ï¼š<span id="atmTotal" style="color:#673ab7;font-size:1.25em;">0</span> ãƒ™ãƒ«
      </div>
    </div>

    <!-- ãƒ¡ãƒ¢ -->
    <div class="box memo">
      <div class="header-left" style="margin-bottom:10px;">ã€ğŸ“ãƒ¡ãƒ¢ã€‘</div>

      <div class="memo-white" style="margin-bottom:10px;">
        <div class="memo-mini">
          <b><ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>ã§ã‚«ãƒãƒ³ã‚’<ruby>æº€ã‚¿ãƒ³<rt>ã¾ã‚“ãŸã‚“</rt></ruby>ã«<ruby>è²·<rt>ã‹</rt></ruby>ã†ã¨ãã®<ruby>æ”¯æ‰•<rt>ã—ã¯ã‚‰</rt></ruby>ã„ï¼š</b><br>
          <span class="mono"><span id="memoPayBags">0è¢‹ï¼‹0ãƒ™ãƒ«</span></span>
          ï¼ˆ<ruby>æ”¯æ‰•é¡åˆè¨ˆ<rt>ã—ã¯ã‚‰ã„ãŒãã”ã†ã‘ã„</rt></ruby>ï¼š<span class="mono"><span id="memoPayTotal">0</span></span>ãƒ™ãƒ«ï¼‰
        </div>
      </div>

      <div class="memo-white" style="margin-bottom:12px;">
        <div class="memo-mini">
          <b>ã“ã®<ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby>ã§ã®<ruby>ç›®æ¨™<rt>ã‚‚ãã²ã‚‡ã†</rt></ruby>ã¾ã§ã®<ruby>å¾€å¾©ç›®å®‰<rt>ãŠã†ãµãã‚ã‚„ã™</rt></ruby>ï¼š</b><br>
          <span class="mono"><span id="memoTripsToGoal">0</span></span> <ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby>
          <span style="opacity:.85;">ï¼ˆã‚«ãƒãƒ³<ruby>æº€ã‚¿ãƒ³è³¼å…¥<rt>ã¾ã‚“ãŸã‚“ã“ã†ã«ã‚…ã†</rt></ruby><ruby>å‰æ<rt>ãœã‚“ã¦ã„</rt></ruby>ï¼‰</span>
        </div>
      </div>

      <div class="memo-mini"><b><ruby>ä½•å¾€å¾©<rt>ãªã‚“ãŠã†ãµã</rt></ruby>ã—ãŸã‹</b></div>

      <div class="memo-row" style="margin-top:6px;">
        <div class="counter">
          <span class="memo-mini"><b><ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>ï¼š</b></span>
          <button class="btn small" id="buyTripMinus" type="button">âˆ’</button>
          <div class="val"><span id="buyTripCount">0</span></div>
          <button class="btn small" id="buyTripPlus" type="button">ï¼‹</button>
          <button class="btn small danger" id="buyTripReset" type="button"><ruby>æ¶ˆ<rt>ã‘</rt></ruby>ã™</button>
        </div>
      </div>

      <div class="memo-row" style="margin-top:10px;">
        <div class="counter">
          <span class="memo-mini"><b><ruby>å£²å€¤<rt>ã†ã‚Šã­</rt></ruby>ï¼š</b></span>
          <button class="btn small" id="sellTripMinus" type="button">âˆ’</button>
          <div class="val"><span id="sellTripCount">0</span></div>
          <button class="btn small" id="sellTripPlus" type="button">ï¼‹</button>
          <button class="btn small danger" id="sellTripReset" type="button"><ruby>æ¶ˆ<rt>ã‘</rt></ruby>ã™</button>
        </div>
      </div>

      <div class="shortcut-box">
        <div class="shortcut-head">
          <div class="memo-mini"><b>ğŸ® ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ã‚«ãƒãƒ³<ruby>é…ç½®<rt>ã¯ã„ã¡</rt></ruby>ãƒ¡ãƒ¢</b></div>
          <div class="memo-row">
            <button class="btn small primary" id="shortcutDefault" type="button">åŸºæœ¬ã‚»ãƒƒãƒˆã‚’<ruby>å…¥<rt>ã„</rt></ruby>ã‚Œã‚‹</button>
            <button class="btn small danger" id="shortcutClear" type="button">ã“ã“ã ã‘<ruby>æ¶ˆ<rt>ã‘</rt></ruby>ã™</button>
          </div>
        </div>

        <div class="shortcut-grid" id="shortcutGrid"></div>

        <div style="height:10px;"></div>
        <div class="memo-mini">è‡ªç”±ãƒ¡ãƒ¢ï¼šã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ»<ruby>é“å…·<rt>ã©ã†ã</rt></ruby>ã®<ruby>ä¸¦<rt>ãªã‚‰</rt></ruby>ã³ã‚’æ›¸ã„ã¦OK</div>
        <textarea id="shortcutMemo" rows="3" placeholder="ä¾‹ï¼šï¼»ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼½â¬†ï¸ãƒ‘ãƒãƒ³ã‚³ â†—ï¸ã¤ã‚Šã–ãŠ â†˜ï¸ã‚¹ã‚³ãƒƒãƒ— â€¦ / ï¼»ã‚«ãƒãƒ³é…ç½®ï¼½ãƒ‘ãƒãƒ³ã‚³ã€ãŸã‹ã¨ã³ã¼ã†ã€ãŠã®ã€ğŸ£ã€è™«ç¶²ã€ã˜ã‚‡ã†ã‚ã€ã¯ã—ã”ã€ã‚¹ã‚³ãƒƒãƒ—"></textarea>
      </div>

      <div style="height:12px;"></div>
      <div class="memo-row"><button class="btn danger" id="clearMemoAll" type="button"><ruby>ãƒ¡ãƒ¢<rt>ã‚ã‚‚</rt></ruby>ã‚’<ruby>å…¨æ¶ˆå»<rt>ãœã‚“ã—ã‚‡ã†ãã‚‡</rt></ruby></button></div>
    </div>
  </div>

  <script>
    const COOKIE_KEY = "kabutool_state_full_v15";

    function setCookie(name, value, days){
      const d=new Date();
      d.setTime(d.getTime()+days*24*60*60*1000);
      document.cookie = name+"="+encodeURIComponent(value)+"; expires="+d.toUTCString()+"; path=/; SameSite=Lax";
    }
    function getCookie(name){
      const target=name+"=";
      const parts=document.cookie.split("; ");
      for(const p of parts){
        if(p.indexOf(target)===0) return decodeURIComponent(p.substring(target.length));
      }
      return "";
    }
    function loadState(){
      const raw=getCookie(COOKIE_KEY);
      if(!raw) return null;
      try{ return JSON.parse(raw);}catch(e){ return null;}
    }
    function saveState(partial){
      const current=loadState()||{};
      const next={...current,...partial,_savedAt:Date.now()};
      setCookie(COOKIE_KEY, JSON.stringify(next), 365);
    }

    function parseNumber(str){ return Number((str||"").replace(/,/g,""))||0; }
    function toComma(n){ return (Number(n)||0).toLocaleString(); }
    function toBagsText(bells){
      const total=Math.max(0, Math.floor(Number(bells)||0));
      const bags=Math.floor(total/99000);
      const rem=total%99000;
      return `${toComma(bags)}è¢‹ï¼‹${toComma(rem)}ãƒ™ãƒ«`;
    }

    let isComposing=false;

    function digitsLeftOfCaret(value, caret){
      const left=value.slice(0, caret);
      return (left.match(/[0-9]/g)||[]).length;
    }
    function caretFromDigitIndex(formattedValue, digitIndex){
      if(digitIndex<=0) return 0;
      let count=0;
      for(let i=0;i<formattedValue.length;i++){
        if(/[0-9]/.test(formattedValue[i])) count++;
        if(count===digitIndex) return i+1;
      }
      return formattedValue.length;
    }
    function normalizeDigits(str){
      let v=(str||"").replace(/[ï¼-ï¼™]/g, s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0));
      return v.replace(/[^0-9]/g,"");
    }
    function formatDigitsWithCommas(digits){
      const s=String(digits||"");
      if(s==="") return "";
      return s.replace(/\B(?=(\d{3})+(?!\d))/g,",");
    }

    // ç›®æ¨™ï¼šã©ã“ã§å‰Šã£ã¦ã‚‚æ¡ãŒè½ã¡ã‚‹ï¼é€”ä¸­å…¥ã‚Œæ›¿ãˆã¯å³0ç¶­æŒ
    let targetFixedLen=0;
    let targetBefore=null;
    function captureTargetBeforeInput(e){
      const el=e.target;
      if(!el || el.id!=="targetBank") return;
      targetBefore={
        inputType: e.inputType||"",
        start: el.selectionStart ?? 0,
        end: el.selectionEnd ?? 0,
        value: el.value||"",
        digits: normalizeDigits(el.value||"")
      };
    }
    function isDeleteType(t){ return String(t||"").startsWith("delete"); }
    function isInsertType(t){ return String(t||"").startsWith("insert"); }

    function formatTargetKeepCaret(el){
      const rawBefore=el.value;
      const caretBefore=el.selectionStart ?? rawBefore.length;
      let v=rawBefore.replace(/[ï¼-ï¼™]/g, s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0));
      const digitIdx=digitsLeftOfCaret(v, caretBefore);
      const newDigitsRaw=normalizeDigits(v);

      if(!targetFixedLen){
        targetFixedLen = newDigitsRaw ? newDigitsRaw.length : 9;
      }

      const prevDigits=(targetBefore && typeof targetBefore.digits==="string") ? targetBefore.digits : null;
      const prevLen=prevDigits ? prevDigits.length : targetFixedLen;
      const nowLen=newDigitsRaw.length;

      const inputType=(targetBefore && targetBefore.inputType) ? targetBefore.inputType : "";
      const deleting=isDeleteType(inputType) || (prevDigits!==null && nowLen<prevLen);

      let nextDigits=newDigitsRaw;

      if(nextDigits===""){
        el.value="";
        saveState({ targetBank:"" });
        calc();
        return;
      }

      if(deleting){
        targetFixedLen=Math.max(1, nowLen);
      }else{
        if(isInsertType(inputType) && nowLen>targetFixedLen) targetFixedLen=nowLen;
        if(nowLen<targetFixedLen) nextDigits = nextDigits.padEnd(targetFixedLen, "0");
        if(nextDigits.length>targetFixedLen) targetFixedLen=nextDigits.length;
      }

      const formatted=formatDigitsWithCommas(nextDigits);
      el.value=formatted;

      const newCaret=caretFromDigitIndex(formatted, digitIdx);
      try{ el.setSelectionRange(newCaret, newCaret);}catch(e){}

      saveState({ targetBank: el.value });
      calc();
    }

    function formatNormalKeepCaret(el){
      const rawBefore=el.value;
      const caretBefore=el.selectionStart ?? rawBefore.length;
      let v=rawBefore.replace(/[ï¼-ï¼™]/g, s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0));
      const digitIdx=digitsLeftOfCaret(v, caretBefore);

      const rawDigits=v.replace(/[^0-9]/g,"");
      const formatted = rawDigits!=="" ? Number(rawDigits).toLocaleString() : "";
      el.value=formatted;

      const newCaret=caretFromDigitIndex(formatted, digitIdx);
      try{ el.setSelectionRange(newCaret, newCaret);}catch(e){}

      const saveIds=[
        "buyPrice","sellPrice","currentBank","rows","slots","bags",
        "buyRewardTickets","buyRewardFullBags","buyRewardBells",
        "sellRewardTickets","sellRewardFullBags","sellRewardBells"
      ];
      if(saveIds.includes(el.id)) saveState({ [el.id]: el.value });

      calc();
    }

    document.querySelectorAll(".comma-input").forEach(el=>{
      el.addEventListener("compositionstart", ()=>{ isComposing=true; });
      el.addEventListener("compositionend", ()=>{
        isComposing=false;
        if(el.id==="targetBank") formatTargetKeepCaret(el);
        else formatNormalKeepCaret(el);
      });
      el.addEventListener("beforeinput", (e)=>{
        if(el.id==="targetBank") captureTargetBeforeInput(e);
      });
      el.addEventListener("input", ()=>{
        if(isComposing) return;
        if(el.id==="targetBank") formatTargetKeepCaret(el);
        else formatNormalKeepCaret(el);
      });
    });

    // å¯¾ä¾¡ï¼šæ å†…ã§å®Œçµï¼ˆé …ç›®ã”ã¨ã«ä¸­èº«ã‚’å†…åŒ…ï¼‰
    const buyRewardEnabledEl = document.getElementById("buyRewardEnabled");
    const sellRewardEnabledEl = document.getElementById("sellRewardEnabled");
    const buyRewardPanel = document.getElementById("buyRewardPanel");
    const sellRewardPanel = document.getElementById("sellRewardPanel");

    const buyRewardTicketsEl = document.getElementById("buyRewardTickets");
    const buyRewardFullBagsEl = document.getElementById("buyRewardFullBags");
    const buyRewardBellsEl = document.getElementById("buyRewardBells");
    const buyRewardOtherEl = document.getElementById("buyRewardOther");

    const sellRewardTicketsEl = document.getElementById("sellRewardTickets");
    const sellRewardFullBagsEl = document.getElementById("sellRewardFullBags");
    const sellRewardBellsEl = document.getElementById("sellRewardBells");
    const sellRewardOtherEl = document.getElementById("sellRewardOther");

    const buyChkTickets = document.getElementById("buyChkTickets");
    const buyChkBells = document.getElementById("buyChkBells");
    const buyChkOther = document.getElementById("buyChkOther");
    const buyItemTickets = document.getElementById("buyItemTickets");
    const buyItemBells = document.getElementById("buyItemBells");
    const buyItemOther = document.getElementById("buyItemOther");
    const buyFieldsTickets = document.getElementById("buyFieldsTickets");
    const buyFieldsBells = document.getElementById("buyFieldsBells");
    const buyFieldsOther = document.getElementById("buyFieldsOther");

    const sellChkTickets = document.getElementById("sellChkTickets");
    const sellChkBells = document.getElementById("sellChkBells");
    const sellChkOther = document.getElementById("sellChkOther");
    const sellItemTickets = document.getElementById("sellItemTickets");
    const sellItemBells = document.getElementById("sellItemBells");
    const sellItemOther = document.getElementById("sellItemOther");
    const sellFieldsTickets = document.getElementById("sellFieldsTickets");
    const sellFieldsBells = document.getElementById("sellFieldsBells");
    const sellFieldsOther = document.getElementById("sellFieldsOther");

    function openFields(fieldsEl, open){ fieldsEl.classList.toggle("open", !!open); }
    function setItemFilled(itemEl, filled){ itemEl.classList.toggle("filled", !!filled); }

    function applyRewardPanels(){
      buyRewardPanel.classList.toggle("open", !!buyRewardEnabledEl.checked);
      sellRewardPanel.classList.toggle("open", !!sellRewardEnabledEl.checked);
    }

    function clearBuyRewardAll(){
      buyRewardTicketsEl.value="";
      buyRewardFullBagsEl.value="";
      buyRewardBellsEl.value="";
      buyRewardOtherEl.value="";
      saveState({buyRewardTickets:"",buyRewardFullBags:"",buyRewardBells:"",buyRewardOther:""});
      buyChkTickets.checked=false;
      buyChkBells.checked=false;
      buyChkOther.checked=false;
      refreshRewardItems();
    }
    function clearSellRewardAll(){
      sellRewardTicketsEl.value="";
      sellRewardFullBagsEl.value="";
      sellRewardBellsEl.value="";
      sellRewardOtherEl.value="";
      saveState({sellRewardTickets:"",sellRewardFullBags:"",sellRewardBells:"",sellRewardOther:""});
      sellChkTickets.checked=false;
      sellChkBells.checked=false;
      sellChkOther.checked=false;
      refreshRewardItems();
    }

    buyRewardEnabledEl.addEventListener("change", ()=>{
      const on=!!buyRewardEnabledEl.checked;
      saveState({ buyRewardEnabled:on });
      applyRewardPanels();
      if(!on) clearBuyRewardAll();
      calc();
    });
    sellRewardEnabledEl.addEventListener("change", ()=>{
      const on=!!sellRewardEnabledEl.checked;
      saveState({ sellRewardEnabled:on });
      applyRewardPanels();
      if(!on) clearSellRewardAll();
      calc();
    });

    buyRewardOtherEl.addEventListener("input", ()=>{
      saveState({ buyRewardOther: buyRewardOtherEl.value });
      refreshRewardItems();
    });
    sellRewardOtherEl.addEventListener("input", ()=>{
      saveState({ sellRewardOther: sellRewardOtherEl.value });
      refreshRewardItems();
    });

    function hasBuyTickets(){ return parseNumber(buyRewardTicketsEl.value)>0; }
    function hasBuyBells(){ return parseNumber(buyRewardFullBagsEl.value)>0 || parseNumber(buyRewardBellsEl.value)>0; }
    function hasBuyOther(){ return (buyRewardOtherEl.value||"").trim().length>0; }

    function hasSellTickets(){ return parseNumber(sellRewardTicketsEl.value)>0; }
    function hasSellBells(){ return parseNumber(sellRewardFullBagsEl.value)>0 || parseNumber(sellRewardBellsEl.value)>0; }
    function hasSellOther(){ return (sellRewardOtherEl.value||"").trim().length>0; }

    function refreshRewardItems(){
      const bt=hasBuyTickets(), bb=hasBuyBells(), bo=hasBuyOther();
      buyChkTickets.checked = bt || buyChkTickets.checked;
      buyChkBells.checked = bb || buyChkBells.checked;
      buyChkOther.checked = bo || buyChkOther.checked;
      setItemFilled(buyItemTickets, bt);
      setItemFilled(buyItemBells, bb);
      setItemFilled(buyItemOther, bo);
      openFields(buyFieldsTickets, !!buyChkTickets.checked);
      openFields(buyFieldsBells, !!buyChkBells.checked);
      openFields(buyFieldsOther, !!buyChkOther.checked);

      const st=hasSellTickets(), sb=hasSellBells(), so=hasSellOther();
      sellChkTickets.checked = st || sellChkTickets.checked;
      sellChkBells.checked = sb || sellChkBells.checked;
      sellChkOther.checked = so || sellChkOther.checked;
      setItemFilled(sellItemTickets, st);
      setItemFilled(sellItemBells, sb);
      setItemFilled(sellItemOther, so);
      openFields(sellFieldsTickets, !!sellChkTickets.checked);
      openFields(sellFieldsBells, !!sellChkBells.checked);
      openFields(sellFieldsOther, !!sellChkOther.checked);
    }

    function clearBuyTicketsOnly(){ buyRewardTicketsEl.value=""; saveState({buyRewardTickets:""}); }
    function clearBuyBellsOnly(){ buyRewardFullBagsEl.value=""; buyRewardBellsEl.value=""; saveState({buyRewardFullBags:"",buyRewardBells:""}); }
    function clearBuyOtherOnly(){ buyRewardOtherEl.value=""; saveState({buyRewardOther:""}); }

    function clearSellTicketsOnly(){ sellRewardTicketsEl.value=""; saveState({sellRewardTickets:""}); }
    function clearSellBellsOnly(){ sellRewardFullBagsEl.value=""; sellRewardBellsEl.value=""; saveState({sellRewardFullBags:"",sellRewardBells:""}); }
    function clearSellOtherOnly(){ sellRewardOtherEl.value=""; saveState({sellRewardOther:""}); }

    buyChkTickets.addEventListener("change", ()=>{ if(!buyChkTickets.checked) clearBuyTicketsOnly(); refreshRewardItems(); calc(); });
    buyChkBells.addEventListener("change", ()=>{ if(!buyChkBells.checked) clearBuyBellsOnly(); refreshRewardItems(); calc(); });
    buyChkOther.addEventListener("change", ()=>{ if(!buyChkOther.checked) clearBuyOtherOnly(); refreshRewardItems(); calc(); });

    sellChkTickets.addEventListener("change", ()=>{ if(!sellChkTickets.checked) clearSellTicketsOnly(); refreshRewardItems(); calc(); });
    sellChkBells.addEventListener("change", ()=>{ if(!sellChkBells.checked) clearSellBellsOnly(); refreshRewardItems(); calc(); });
    sellChkOther.addEventListener("change", ()=>{ if(!sellChkOther.checked) clearSellOtherOnly(); refreshRewardItems(); calc(); });

    ["input","change"].forEach(ev=>{
      buyRewardTicketsEl.addEventListener(ev, ()=>{ refreshRewardItems(); calc(); });
      buyRewardFullBagsEl.addEventListener(ev, ()=>{ refreshRewardItems(); calc(); });
      buyRewardBellsEl.addEventListener(ev, ()=>{ refreshRewardItems(); calc(); });
      sellRewardTicketsEl.addEventListener(ev, ()=>{ refreshRewardItems(); calc(); });
      sellRewardFullBagsEl.addEventListener(ev, ()=>{ refreshRewardItems(); calc(); });
      sellRewardBellsEl.addEventListener(ev, ()=>{ refreshRewardItems(); calc(); });
    });

    const buyTripEl=document.getElementById("buyTripCount");
    const sellTripEl=document.getElementById("sellTripCount");
    function clampInt(v){ return Math.max(0, Math.floor(Number(v)||0)); }
    function setCounter(el,key,v){
      const n=clampInt(v);
      el.textContent=toComma(n);
      saveState({[key]:n});
    }
    function getCounter(el){ return parseNumber(el.textContent); }

    document.getElementById("buyTripPlus").addEventListener("click", ()=> setCounter(buyTripEl,"buyTripCount",getCounter(buyTripEl)+1));
    document.getElementById("buyTripMinus").addEventListener("click",()=> setCounter(buyTripEl,"buyTripCount",getCounter(buyTripEl)-1));
    document.getElementById("buyTripReset").addEventListener("click",()=> setCounter(buyTripEl,"buyTripCount",0));

    document.getElementById("sellTripPlus").addEventListener("click", ()=> setCounter(sellTripEl,"sellTripCount",getCounter(sellTripEl)+1));
    document.getElementById("sellTripMinus").addEventListener("click",()=> setCounter(sellTripEl,"sellTripCount",getCounter(sellTripEl)-1));
    document.getElementById("sellTripReset").addEventListener("click",()=> setCounter(sellTripEl,"sellTripCount",0));

    function clearField(id){
      const el=document.getElementById(id);
      el.value="";
      saveState({[id]:""});
      calc();
      el.focus();
    }
    document.getElementById("clearBuy").addEventListener("click", ()=> clearField("buyPrice"));
    document.getElementById("clearSell").addEventListener("click",()=> clearField("sellPrice"));
    document.getElementById("clearCurrent").addEventListener("click",()=> clearField("currentBank"));
    document.getElementById("clearTarget").addEventListener("click", ()=>{
      targetFixedLen=0;
      targetBefore=null;
      clearField("targetBank");
    });

    // Shortcuts
    const TOOL_LIST=[
      {key:"",label:"ï¼ˆæœªè¨­å®šï¼‰",img:""},
      {key:"scop",label:"ã‚¹ã‚³ãƒƒãƒ—",img:"img/scop.png"},
      {key:"turizao",label:"ã¤ã‚Šã–ãŠ",img:"img/turizao.png"},
      {key:"musiami",label:"ã‚ã¿",img:"img/musiami.png"},
      {key:"ono",label:"ã‚ªãƒ",img:"img/ono.png"},
      {key:"pachinko",label:"ãƒ‘ãƒãƒ³ã‚³",img:"img/pachinko.png"},
      {key:"jouro",label:"ã‚¸ãƒ§ã‚¦ãƒ­",img:"img/jouro.png"},
      {key:"takatobi",label:"ãŸã‹ã¨ã³ã¼ã†",img:"img/takatobi.png"},
      {key:"hashigo",label:"ã¯ã—ã”",img:"img/hashigo.png"},
      {key:"sutekki",label:"ã‚¹ãƒ†ãƒƒã‚­",img:"img/sutekki.png"},
      {key:"timer",label:"ã‚¿ã‚¤ãƒãƒ¼",img:"img/timer.png"},
      {key:"megahon",label:"ãƒ¡ã‚¬ãƒ›ãƒ³",img:"img/megahon.png"}
    ];
    const DIRS=[
      {id:"up",label:"â¬†ï¸ ä¸Š"},
      {id:"ur",label:"â†—ï¸ å³ä¸Š"},
      {id:"right",label:"â¡ï¸ å³"},
      {id:"dr",label:"â†˜ï¸ å³ä¸‹"},
      {id:"down",label:"â¬‡ï¸ ä¸‹"},
      {id:"dl",label:"â†™ï¸ å·¦ä¸‹"},
      {id:"left",label:"â¬…ï¸ å·¦"},
      {id:"ul",label:"â†–ï¸ å·¦ä¸Š"}
    ];
    const shortcutGrid=document.getElementById("shortcutGrid");
    const shortcutMemoEl=document.getElementById("shortcutMemo");

    function toolByKey(key){ return TOOL_LIST.find(t=>t.key===key)||TOOL_LIST[0]; }
    const FALLBACK_IMG="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";

    function renderShortcutUI(state){
      shortcutGrid.innerHTML="";
      const st=loadState()||{};
      const shortcuts=(state && state.shortcuts)? state.shortcuts : (st.shortcuts||{});

      DIRS.forEach(d=>{
        const curKey=shortcuts[d.id]?String(shortcuts[d.id]):"";
        const curTool=toolByKey(curKey);

        const item=document.createElement("div");
        item.className="shortcut-item";

        const top=document.createElement("div");
        top.className="shortcut-top";
        const dir=document.createElement("div");
        dir.className="dir";
        dir.textContent=d.label;
        top.appendChild(dir);
        item.appendChild(top);

        const view=document.createElement("div");
        view.className="tool-view";

        const img=document.createElement("img");
        img.className="tool-img";
        img.alt=curTool.label;
        img.src=curTool.img||FALLBACK_IMG;
        img.onerror=()=>{img.src=FALLBACK_IMG;};
        view.appendChild(img);

        const select=document.createElement("select");
        TOOL_LIST.forEach(t=>{
          const opt=document.createElement("option");
          opt.value=t.key;
          opt.textContent=t.label;
          if(t.key===curKey) opt.selected=true;
          select.appendChild(opt);
        });
        select.addEventListener("change", ()=>{
          const nextKey=select.value;
          const nextTool=toolByKey(nextKey);
          img.src=nextTool.img||FALLBACK_IMG;
          img.alt=nextTool.label;
          const cur=loadState()||{};
          const next={...(cur.shortcuts||{})};
          next[d.id]=nextKey;
          saveState({ shortcuts: next });
        });

        view.appendChild(select);
        item.appendChild(view);
        shortcutGrid.appendChild(item);
      });
    }

    function setShortcutDefault(){
      const defaults={up:"pachinko",ur:"turizao",right:"scop",dr:"musiami",down:"takatobi",dl:"ono",left:"hashigo",ul:"jouro"};
      saveState({ shortcuts: defaults });
      renderShortcutUI({ shortcuts: defaults });
    }
    function clearShortcutsOnly(){
      saveState({ shortcuts:{} });
      renderShortcutUI({ shortcuts:{} });
      shortcutMemoEl.value="";
      saveState({ shortcutMemo:"" });
    }
    document.getElementById("shortcutDefault").addEventListener("click", setShortcutDefault);
    document.getElementById("shortcutClear").addEventListener("click", clearShortcutsOnly);
    shortcutMemoEl.addEventListener("input", ()=> saveState({ shortcutMemo: shortcutMemoEl.value }));

    document.getElementById("clearMemoAll").addEventListener("click", ()=>{
      setCounter(buyTripEl,"buyTripCount",0);
      setCounter(sellTripEl,"sellTripCount",0);
      shortcutMemoEl.value="";
      saveState({ shortcutMemo:"" });
    });

    function setPlanEmptyState(isEmpty){
      const plan=document.getElementById("planOutput");
      if(isEmpty) plan.classList.add("plan-empty");
      else plan.classList.remove("plan-empty");
    }

    function calc(){
      const buyVal=document.getElementById("buyPrice").value;
      const sellVal=document.getElementById("sellPrice").value;
      const rowsInput=document.getElementById("rows");
      const slotsInput=document.getElementById("slots");
      const bankVal=document.getElementById("currentBank").value;
      const targetVal=document.getElementById("targetBank").value;
      const bagsVal=document.getElementById("bags").value;

      const maxAlert=document.getElementById("maxAlert");

      let rows=parseNumber(rowsInput.value);
      let slots=parseNumber(slotsInput.value);

      if(rows>=4){
        rows=4;
        rowsInput.value="4";
        slots=0;
        slotsInput.value="";
        slotsInput.disabled=true;
        maxAlert.style.display="block";
      }else{
        slotsInput.disabled=false;
        maxAlert.style.display="none";
        if(slots>9){
          slots=9;
          slotsInput.value="9";
        }
      }

      const bPrice=parseNumber(buyVal);
      const sPrice=parseNumber(sellVal);
      const currentBank=parseNumber(bankVal);
      const targetBank= targetVal==="" ? 0 : parseNumber(targetVal);
      const bags=parseNumber(bagsVal);

      const totalCapacitySlots=(rows*10)+slots;
      const capacityStocks=totalCapacitySlots*100;

      const costCurrent=capacityStocks*bPrice;
      const salesCurrent=capacityStocks*sPrice;
      const profitCurrent=(sPrice-bPrice)*capacityStocks;

      document.getElementById("currentCapacityText").innerText=toComma(totalCapacitySlots);
      document.getElementById("totalStocks").innerText=toComma(capacityStocks);
      document.getElementById("targetStocks").innerText=toComma(capacityStocks);

      document.getElementById("cost").innerText=toComma(costCurrent);
      document.getElementById("sales").innerText=toComma(salesCurrent);
      document.getElementById("profit").innerText=toComma(profitCurrent);

      document.getElementById("costBags").innerText=toBagsText(costCurrent);
      document.getElementById("salesBags").innerText=toBagsText(salesCurrent);

      const needed=Math.max(0, targetBank-currentBank);
      document.getElementById("neededAmount").innerText=toComma(needed);

      document.getElementById("atmTotal").innerText=toComma(bags*99000);

      const canFillBag=(bPrice>0)&&(totalCapacitySlots>0)&&(currentBank>=costCurrent);
      const depositSuggest= canFillBag ? Math.max(0, salesCurrent-costCurrent) : 0;

      document.getElementById("atmSuggestBags").innerText=toBagsText(depositSuggest);
      document.getElementById("atmSuggestTotal").innerText=toComma(depositSuggest);
      document.getElementById("atmCapacityText").innerText=toComma(totalCapacitySlots);

      document.getElementById("memoPayBags").innerText=toBagsText(costCurrent);
      document.getElementById("memoPayTotal").innerText=toComma(costCurrent);

      const perTripProfit=profitCurrent;
      const tripsToGoal=(perTripProfit>0)? Math.ceil(needed/perTripProfit) : 0;
      document.getElementById("memoTripsToGoal").innerText=toComma(tripsToGoal);

      const fullProfitPerTrip=(sPrice-bPrice)*4000;
      const tripsToGoalFull=(fullProfitPerTrip>0)? Math.ceil(needed/fullProfitPerTrip) : 0;

      document.getElementById("tripsFull").innerText=toComma(tripsToGoalFull);
      document.getElementById("tripsCurrent").innerText=toComma(tripsToGoal);

      refreshRewardItems();

      // è²·å€¤ï¼šãƒ™ãƒ«å¯¾ä¾¡ãŒã‚ã‚‹æ™‚ã ã‘è¡¨ç¤ºï¼ˆãƒã‚¤ãƒã‚±/ä»–ã‚¢ã‚¤ãƒ†ãƒ ã§ã¯å‡ºã•ãªã„ï¼‰
      const buyRewardResult=document.getElementById("buyRewardResult");
      const buyRewardEnabled = !!buyRewardEnabledEl.checked;
      const buyBags = (buyRewardEnabled && buyChkBells.checked) ? parseNumber(buyRewardFullBagsEl.value) : 0;
      const buyBells = (buyRewardEnabled && buyChkBells.checked) ? parseNumber(buyRewardBellsEl.value) : 0;
      const buyRewardPayBells=Math.max(0, (buyBags*99000)+buyBells);
      const showBuyRewardResult = buyRewardEnabled && buyRewardPayBells>0;

      if(showBuyRewardResult){
        buyRewardResult.classList.add("open");
        const costWithReward=Math.max(0, costCurrent + buyRewardPayBells);
        document.getElementById("costWithReward").innerText=toComma(costWithReward);
        document.getElementById("costWithRewardBags").innerText=toBagsText(costWithReward);
      }else{
        buyRewardResult.classList.remove("open");
      }

      // ATMï¼ˆå£²å€¤å´ï¼‰ï¼šãƒã‚§ãƒƒã‚¯ONã®ã€Œãƒ™ãƒ«ã€ã ã‘å·®ã—å¼•ã
      const sellRewardEnabled = !!sellRewardEnabledEl.checked;
      const sellTickets = (sellRewardEnabled && sellChkTickets.checked) ? parseNumber(sellRewardTicketsEl.value) : 0;
      const sellBags = (sellRewardEnabled && sellChkBells.checked) ? parseNumber(sellRewardFullBagsEl.value) : 0;
      const sellBells = (sellRewardEnabled && sellChkBells.checked) ? parseNumber(sellRewardBellsEl.value) : 0;
      const sellOther = (sellRewardEnabled && sellChkOther.checked) ? (sellRewardOtherEl.value||"").trim() : "";

      const rewardSubtract=Math.max(0, (sellBags*99000)+sellBells);
      const depositAdjusted=Math.max(0, depositSuggest - rewardSubtract);

      const atmAdjustWrap=document.getElementById("atmAdjustWrap");
      const chipRow=document.getElementById("atmChipRow");
      chipRow.innerHTML="";

      const hasAnyReward = sellRewardEnabled && (sellTickets>0 || rewardSubtract>0 || sellOther.length>0);
      if(hasAnyReward){
        if(sellTickets>0){
          const chip=document.createElement("div");
          chip.className="atm-chip";
          chip.innerHTML=`<b>ğŸ« ãƒã‚¤ãƒã‚±</b>ï¼š<span class="mono">${toComma(sellTickets)}</span>æš`;
          chipRow.appendChild(chip);
        }
        if(rewardSubtract>0){
          const chip=document.createElement("div");
          chip.className="atm-chip";
          chip.innerHTML=`<b>å¯¾ä¾¡ã®å·®ã—å¼•ã</b>ï¼š<span class="mono">${toBagsText(rewardSubtract)}</span>`;
          chipRow.appendChild(chip);
        }
        if(sellOther.length>0){
          const chip=document.createElement("div");
          chip.className="atm-chip";
          chip.innerHTML=`<b>ä»–ã‚¢ã‚¤ãƒ†ãƒ </b>ï¼š<span class="mono">${sellOther.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</span>`;
          chipRow.appendChild(chip);
        }

        document.getElementById("atmAdjustedTotal").innerText=toComma(rewardSubtract>0 ? depositAdjusted : depositSuggest);
        document.getElementById("atmAdjustedBags").innerText=toBagsText(rewardSubtract>0 ? depositAdjusted : depositSuggest);
        atmAdjustWrap.style.display="block";
      }else{
        atmAdjustWrap.style.display="none";
      }

      // ã‚ã‚‰ã—ã¹
      const tripDisplay=document.getElementById("tripDisplay");
      const tripAlert=document.getElementById("tripAlert");
      const planOut=document.getElementById("planOutput");

      if(buyVal==="" || sellVal==="" || bankVal===""){
        tripDisplay.style.display="grid";
        tripAlert.style.display="none";
        setPlanEmptyState(true);
        planOut.innerHTML=`<div class="empty-msg"><ruby>è²·å€¤<rt>ã‹ã„ã­</rt></ruby>ãƒ»<ruby>å£²å€¤<rt>ã†ã‚Šã­</rt></ruby>ãƒ»<ruby>è²¯é‡‘<rt>ã¡ã‚‡ãã‚“</rt></ruby>ã‚’<ruby>å…¥<rt>ã„</rt></ruby>ã‚Œã¦ã­</div>`;
        return;
      }

      if(!(sPrice>bPrice)){
        setPlanEmptyState(false);
        planOut.textContent="å£²å€¤ã¯è²·å€¤ã‚ˆã‚Šé«˜ãè¨­å®šã—ã¦ãã ã•ã„ã€‚";
        tripDisplay.style.display="grid";
        tripAlert.style.display="none";
        return;
      }

      const needToFillBag=costCurrent;
      let tempBank=currentBank;
      let stepCount=0;
      let log="";

      const notEnoughNow=tempBank<needToFillBag;

      while(tempBank<needToFillBag && stepCount<200){
        stepCount++;
        const buyAmount=Math.floor(tempBank/bPrice);
        const profit=buyAmount*(sPrice-bPrice);
        if(stepCount<=8){
          log += `<li>${stepCount}<ruby>å›ç›®<rt>ã‹ã„ã‚</rt></ruby>ï¼š${toComma(buyAmount)}ã‚«ãƒ–<ruby>è³¼å…¥<rt>ã“ã†ã«ã‚…ã†</rt></ruby></li>`;
        }
        tempBank += profit;
        if(profit<=0) break;
      }

      if(notEnoughNow){
        tripDisplay.style.display="none";
        tripAlert.style.display="block";
      }else{
        tripDisplay.style.display="grid";
        tripAlert.style.display="none";
      }

      setPlanEmptyState(false);

      let message=`<div><b>ã‚«ãƒãƒ³(${totalCapacitySlots}ãƒã‚¹)</b>ã‚’<ruby>æº€ã‚¿ãƒ³<rt>ã¾ã‚“ãŸã‚“</rt></ruby>ã«ã™ã‚‹<ruby>è¨ˆç”»<rt>ã‘ã„ã‹ã</rt></ruby>ï¼š</div>`;

      if(!notEnoughNow){
        message += `<div style="margin:8px 0;font-weight:900;color:#00796b;">1<ruby>å›ç›®<rt>ã‹ã„ã‚</rt></ruby>ã‹ã‚‰ã‚«ãƒãƒ³ã‚’<ruby>æº€ã‚¿ãƒ³<rt>ã¾ã‚“ãŸã‚“</rt></ruby>ã«ã§ãã¾ã™ï¼</div>`;
      }else{
        message += `<ul>${log}</ul>`;
        if(stepCount>8){
          const rest=stepCount-8;
          message += `
            <div style="margin-top:6px;font-weight:900;color:#00695c;">...ã‚ã¨ ${rest} <ruby>å›<rt>ã‹ã„</rt></ruby>ã®<ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby>...</div>
            <div style="font-weight:900;color:#00695c;">ï¼ˆ8<ruby>å›ç›®<rt>ã‹ã„ã‚</rt></ruby>ã¨<ruby>åŒ<rt>ãŠãª</rt></ruby>ã˜ã‚ˆã†ã«<ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby>ã—ã¦<ruby>è³‡é‡‘<rt>ã—ãã‚“</rt></ruby>ã‚’<ruby>è²¯<rt>ãŸ</rt></ruby>ã‚ã¾ã™ï¼‰</div>
          `;
        }
        message += `<div style="margin-top:10px;font-weight:900;">ã‚ã¨ <span class="red-val">${toComma(stepCount)}</span> <ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby>ã§ã‚«ãƒãƒ³ãŒã„ã£ã±ã„ã«ãªã‚Šã¾ã™ã€‚</div>`;
      }

      message += `<hr class="plan-hr"><div style="font-weight:900;"><ruby>ç›®æ¨™é”æˆ<rt>ã‚‚ãã²ã‚‡ã†ãŸã£ã›ã„</rt></ruby>ã¾ã§ã‚ã¨ <span class="red-val">${toComma(tripsToGoal)}</span> <ruby>å¾€å¾©<rt>ãŠã†ãµã</rt></ruby>ã§ã™ã€‚</div>`;
      planOut.innerHTML=message;
    }

    const rubyBtn=document.getElementById("rubyToggle");
    rubyBtn.addEventListener("click", ()=>{
      document.body.classList.toggle("no-ruby");
      rubyBtn.textContent = document.body.classList.contains("no-ruby") ? "ãµã‚ŠãŒãªï¼šOFF" : "ãµã‚ŠãŒãªï¼šON";
    });

    (function init(){
      const st=loadState();
      if(st){
        const ids=[
          "buyPrice","sellPrice","currentBank","targetBank","rows","slots","bags",
          "buyRewardTickets","buyRewardFullBags","buyRewardBells",
          "sellRewardTickets","sellRewardFullBags","sellRewardBells"
        ];
        ids.forEach(id=>{
          if(typeof st[id]==="string"){
            const el=document.getElementById(id);
            if(el) el.value=st[id];
          }
        });

        if(typeof st.buyTripCount==="number") document.getElementById("buyTripCount").textContent=toComma(st.buyTripCount);
        if(typeof st.sellTripCount==="number") document.getElementById("sellTripCount").textContent=toComma(st.sellTripCount);

        if(typeof st.shortcutMemo==="string") shortcutMemoEl.value=st.shortcutMemo;

        if(typeof st.buyRewardOther==="string") buyRewardOtherEl.value=st.buyRewardOther;
        if(typeof st.sellRewardOther==="string") sellRewardOtherEl.value=st.sellRewardOther;

        buyRewardEnabledEl.checked=!!st.buyRewardEnabled;
        sellRewardEnabledEl.checked=!!st.sellRewardEnabled;

        renderShortcutUI({ shortcuts: st.shortcuts || {} });
      }else{
        renderShortcutUI({ shortcuts: {} });
      }

      const tb=document.getElementById("targetBank");
      if(tb){
        const d=normalizeDigits(tb.value);
        if(d) targetFixedLen=d.length;
      }

      applyRewardPanels();
      refreshRewardItems();
      calc();
    })();
  </script>
</body>
</html>
